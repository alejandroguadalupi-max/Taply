<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Gestionar suscripción — Taply</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f1a; --card:#0e1424; --txt:#e9eefc; --muted:#9fb0c6; --b:rgba(255,255,255,.12);
      --brand1:#00d4ff; --brand2:#7c3aed; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444
    }
    *{box-sizing:border-box} html,body{height:100%} html{-webkit-text-size-adjust:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui}
    .wrap{width:min(900px,94%);margin:32px auto}
    .card{background:var(--card);border:1px solid var(--b);border-radius:18px;padding:22px;margin-bottom:16px}
    h1{margin:0 0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border:0;border-radius:999px;font-weight:800;cursor:pointer;background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#061017}
    .ghost{padding:10px 14px;border:1px solid var(--b);border-radius:999px;background:transparent;color:inherit}
    .muted{color:var(--muted)}
    input{font-size:16px}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--b);background:rgba(255,255,255,.06);font-weight:800}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    /* Bloque llamativo de suscripción */
    .sub-hero{
      border:1px solid var(--b); border-radius:16px; padding:16px; margin-top:4px;
      background:
        linear-gradient(135deg, rgba(124,58,237,.22), rgba(0,212,255,.18)) border-box,
        linear-gradient(135deg, rgba(255,255,255,.04), rgba(255,255,255,.02)) padding-box;
    }
    .sub-name{
      font-size:clamp(1.2rem, 3.6vw, 1.6rem);
      font-weight:800; letter-spacing:.2px; margin:0;
      background:linear-gradient(135deg,var(--brand1),var(--brand2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .sub-meta{margin:.25rem 0 0; font-size:.98rem; color:var(--muted)}
    .divider{height:1px;background:var(--b);margin:18px 0}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>Gestionar suscripción</h1>
      <div class="row">
        <a class="ghost" href="suscripciones.html">Volver a suscripciones</a>
        <button id="logout" class="ghost">Cerrar sesión</button>
      </div>
    </div>

    <section class="card" id="acctBox">
      <h2 style="margin:0 0 6px">Tu cuenta</h2>
      <p class="muted" id="email">Cargando…</p>

      <!-- Bloque SUSCRIPCIÓN (llamativo) -->
      <div class="sub-hero" id="subHero">
        <p class="sub-name" id="subName">Cargando…</p>
        <!-- línea principal: próxima renovación o fin -->
        <p class="sub-meta" id="renewLine"></p>
        <!-- línea adicional: cancelación programada -->
        <p class="sub-meta hidden" id="cancelLine"></p>
        <!-- línea adicional: cambio de plan programado -->
        <p class="sub-meta hidden" id="swapLine"></p>
        <div id="flags" style="margin-top:6px"></div>
      </div>

      <!-- Botones debajo del bloque de suscripción -->
      <div class="row" style="margin-top:12px">
        <button id="btnChangePlan" class="btn">Gestionar la suscripción</button>
        <button id="btnResume" class="ghost hidden">Reanudar plan</button>
        <a id="btnSeePlans" class="ghost hidden" href="suscripciones.html#planes">Ver planes</a>
      </div>
      <p id="msg" class="muted" style="margin-top:6px"></p>

      <div class="divider"></div>

      <!-- NFC -->
      <section id="nfcBlock">
        <h3 style="margin:0 0 6px">NFC</h3>
        <p class="muted">Has comprado: <strong id="nfcQty">0</strong> dispositivos.</p>
        <div class="row">
          <input id="nfcCount" type="number" min="1" max="999" step="1" value="5" style="background:#0a0f16;border:1px solid var(--b);color:inherit;border-radius:12px;padding:10px;width:120px">
          <button id="buyNfc" class="btn">Comprar más NFC</button>
        </div>
      </section>
    </section>
  </main>

  <script>
    // Si tu API no permite crear portal, usa este fallback (no es secreto).
    const PORTAL_LOGIN_URL = "https://billing.stripe.com/p/login/test_28E28sevk0OcdGMdkX4ko00";

    const $ = s => document.querySelector(s);
    const show  = el => el.classList.remove('hidden');
    const hide  = el => el.classList.add('hidden');
    const setTxt = (sel, txt) => { const el=$(sel); if(el) el.textContent = txt; };
    const fmtTS = ts => new Intl.DateTimeFormat('es-ES',{dateStyle:'long'}).format(new Date(ts*1000));

    async function api(method, url, body){
      const res = await fetch(url,{
        method,
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        cache:'no-store',
        body: body?JSON.stringify(body):undefined
      });
      let data=null; try{ data=await res.json(); }catch{}
      if(!res.ok) throw (data?.error||('HTTP_'+res.status));
      return data;
    }

    function getInterval(u){
      return (u?.subscription?.price?.interval ||
              u?.subscription?.plan?.interval ||
              u?.subscription_interval || 'month').toLowerCase();
    }
    function prettyPlan(u){
      const nick=(u?.subscription?.price?.nickname ||
                  u?.subscription?.plan?.nickname || '').trim();
      if(nick) return nick;

      // fallback heurístico si no hay nickname
      const idTxt = ((u?.subscription?.price?.id||'')+' '+(u?.subscription?.plan?.nickname||'')).toLowerCase();
      let base='Básico';
      if(/pro/.test(idTxt)) base='Pro';
      else if(/medio|standard|estándar/.test(idTxt)) base='Medio';
      const freq = getInterval(u)==='year' ? 'Anual' : 'Mensual';
      return `${base} ${freq}`;
    }
    function hasValidSub(u){
      const st=(u?.subscription?.status||'').toLowerCase();
      return ['active','trialing','past_due'].includes(st);
    }

    let USER=null;

    function paintNoSubscription(){
      $('#subName').textContent = 'No tienes suscripción activa';
      setTxt('#renewLine','');
      setTxt('#cancelLine',''); hide($('#cancelLine'));
      setTxt('#swapLine','');   hide($('#swapLine'));
      $('#flags').innerHTML = '';
      hide($('#btnCancel'));
      hide($('#btnResume'));
      show($('#btnSeePlans'));
    }

    async function refreshUser(paintOnly=false){
      try{
        const d = await api('GET','/api/session');
        const u = d?.user;
        if(!u){
          setTxt('#email','Debes iniciar sesión para gestionar tu cuenta.');
          paintNoSubscription();
          return;
        }
        USER=u;

        setTxt('#email', u.email || '—');

        if(hasValidSub(u)){
          // Nombre del plan
          $('#subName').textContent = prettyPlan(u);

          // Banderas visuales
          const flags=[];
          if(u?.subscription?.status){ flags.push(`<span class="tag">Estado: ${u.subscription.status}</span>`); }
          if(u?.subscription?.cancel_at_period_end){ flags.push('<span class="tag warn">Cancelación programada</span>'); }
          $('#flags').innerHTML = flags.join(' ');

          // Fechas principales desde Stripe
          const end = u.current_period_end || u.subscription?.current_period_end || null;
          if(end){
            if(u?.subscription?.cancel_at_period_end){
              setTxt('#renewLine', `Activo hasta el ${fmtTS(end)} (se cancelará en esa fecha).`);
            }else{
              setTxt('#renewLine', `Próxima renovación: ${fmtTS(end)}.`);
            }
          }else{
            setTxt('#renewLine','');
          }

          // Línea específica de cancelación (más explícita)
          if(u?.subscription?.cancel_at_period_end && end){
            setTxt('#cancelLine', `La suscripción está programada para cancelarse el ${fmtTS(end)}.`);
            show($('#cancelLine'));
          }else{
            setTxt('#cancelLine',''); hide($('#cancelLine'));
          }

          // Cambio de plan programado (de /api/session)
          if(u.upcoming_start_date && (u.upcoming_price_nickname || u.upcoming_price_id)){
            const name = u.upcoming_price_nickname || u.upcoming_price_id;
            setTxt('#swapLine', `Cambio de plan programado: ${name} a partir del ${fmtTS(u.upcoming_start_date)}.`);
            show($('#swapLine'));
          }else{
            setTxt('#swapLine',''); hide($('#swapLine'));
          }

          // Botones cancelar/reanudar
          const cancelAtEnd=!!u?.subscription?.cancel_at_period_end;
          if(cancelAtEnd){ hide($('#btnCancel')); show($('#btnResume')); }
          else { show($('#btnCancel')); hide($('#btnResume')); }
          hide($('#btnSeePlans'));
        }else{
          paintNoSubscription();
        }

        // NFC
        setTxt('#nfcQty', String(Number(u.nfc_qty||0)));

        if(!paintOnly){ setTxt('#msg',''); }
      }catch(e){
        setTxt('#email','No se pudo cargar la sesión.');
        $('#subName').textContent = 'Intenta recargar la página';
        setTxt('#renewLine','');
        setTxt('#cancelLine',''); hide($('#cancelLine'));
        setTxt('#swapLine','');   hide($('#swapLine'));
        $('#flags').innerHTML = '';
        show($('#btnSeePlans'));
        console.error('refreshUser error', e);
      }
    }

    // Si venimos de Stripe con ?session_id=..., guardamos cookie y ejecutamos post-pago
    async function runPostPagoIfNeeded(){
      const qs = new URLSearchParams(location.search);
      const sid = qs.get('session_id');
      if(!sid) return;
      try{
        try{ await api('POST','/api/store-customer-from-session',{ session_id: sid }); }catch{}
        try{ await api('POST','/api/post-pago',{ session_id: sid }); }catch{}
        await refreshUser(true);
      }catch(e){ /* silencioso */ }
      try{
        qs.delete('session_id');
        const url = location.pathname + (qs.toString()?('?'+qs.toString()):'');
        history.replaceState({}, '', url);
      }catch{}
    }

    // Portal (para cambios inmediatos, facturas, etc.)
    async function openPortal(){
      try{
        const r=await api('POST','/api/create-portal-session',{});
        if(r?.url){ location.href=r.url; return; }
      }catch(e){ /* si no hay sub válida, cae al fallback */ }
      if(!USER || !hasValidSub(USER)){
        location.href = 'suscripciones.html#planes';
        return;
      }
      let url = PORTAL_LOGIN_URL;
      try{
        if(USER?.email){
          const u = new URL(url);
          u.searchParams.set('prefilled_email', USER.email);
          url = u.toString();
        }
      }catch{}
      location.href = url;
    }

    // Eventos
    $('#btnChangePlan').addEventListener('click', ()=>{
      if(!USER || !hasValidSub(USER)) { location.href='suscripciones.html#planes'; return; }
      openPortal();
    });

    $('#btnCancel').addEventListener('click', async ()=>{
      try{
        await api('POST','/api/subscription/cancel',{ at_period_end:true });
        $('#msg').innerHTML = '<span class="warn">Tu suscripción seguirá activa hasta fin de periodo.</span>';
        await refreshUser();
      }catch(e){
        alert('No se pudo cancelar aquí. Te llevamos al portal para completarlo.');
        openPortal();
      }
    });

    $('#btnResume').addEventListener('click', async ()=>{
      try{
        await api('POST','/api/subscription/resume',{});
        $('#msg').innerHTML = '<span class="ok">La suscripción seguirá renovándose.</span>';
        await refreshUser();
      }catch(e){
        alert('No se pudo reanudar aquí. Te llevamos al portal.');
        openPortal();
      }
    });

    // NFC
    $('#buyNfc').addEventListener('click', async ()=>{
      const q = Math.max(1, Math.min(999, parseInt($('#nfcCount').value||'1',10)||1));
      try{
        const r = await api('POST','/api/buy-nfc',{quantity:q});
        if(r?.url) location.href=r.url; else alert('No se pudo iniciar la compra.');
      }catch{ alert('No se pudo iniciar la compra.'); }
    });

    // Logout
    $('#logout').addEventListener('click', async ()=>{
      try{ await api('POST','/api/logout',{});}catch{}
      location.href='suscripciones.html#cuenta';
    });

    (async function init(){
      await runPostPagoIfNeeded();
      await refreshUser();
    })();
  </script>
</body>
</html>

