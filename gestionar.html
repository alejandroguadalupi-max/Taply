<!doctype html> 
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Gestionar suscripción — Taply</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b0f1a; --card:#0e1424; --txt:#e9eefc; --muted:#9fb0c6; --b:rgba(255,255,255,.12);
           --brand1:#00d4ff; --brand2:#7c3aed; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444 }
    *{box-sizing:border-box} html,body{height:100%} html{-webkit-text-size-adjust:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui}
    .wrap{width:min(900px,94%);margin:32px auto}
    .card{background:var(--card);border:1px solid var(--b);border-radius:18px;padding:22px;margin-bottom:16px}
    h1{margin:0 0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border:0;border-radius:999px;font-weight:800;cursor:pointer;background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#061017}
    .ghost{padding:10px 14px;border:1px solid var(--b);border-radius:999px;background:transparent;color:inherit}
    .muted{color:var(--muted)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:780px){ .grid2{grid-template-columns:1fr} }
    input{font-size:16px}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--b);background:rgba(255,255,255,.04);font-weight:800}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>Gestionar suscripción</h1>
      <div class="row">
        <a class="ghost" href="suscripciones.html">Volver a suscripciones</a>
        <button id="logout" class="ghost">Cerrar sesión</button>
      </div>
    </div>

    <section class="card" id="acctBox">
      <h2 style="margin:0 0 6px">Tu cuenta</h2>
      <p class="muted" id="email">—</p>
      <div class="grid2">
        <div>
          <h3>Suscripción</h3>
          <p id="subLine" class="muted">Cargando…</p>
          <p id="renewLine" class="muted"></p>
          <div id="flags"></div>
          <div class="row" style="margin-top:8px">
            <button id="btnCancel" class="ghost">Cancelar al final del periodo</button>
            <button id="btnResume" class="ghost" style="display:none">Reanudar</button>
            <button id="btnPortal" class="btn">Abrir portal</button>
          </div>
          <p id="msg" class="muted" style="margin-top:8px"></p>
        </div>
        <div>
          <h3>NFC</h3>
          <p class="muted">Has comprado: <strong id="nfcQty">0</strong> dispositivos.</p>
          <div class="row">
            <input id="nfcCount" type="number" min="1" max="999" step="1" value="5" style="background:#0a0f16;border:1px solid var(--b);color:inherit;border-radius:12px;padding:10px;width:120px">
            <button id="buyNfc" class="btn">Comprar más NFC</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 6px">Acciones rápidas</h3>
      <div class="row">
        <button id="changePlan" class="ghost">Cambiar de plan</button>
        <button id="updateCard" class="ghost">Actualizar tarjeta</button>
        <button id="invoices" class="ghost">Ver facturas</button>
      </div>
      <p class="muted" style="margin-top:8px">Estas acciones se abren en el portal de Stripe.</p>
    </section>
  </main>

  <script>
    const $=s=>document.querySelector(s);

    async function api(method, url, body){
      const res = await fetch(url,{
        method,
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        cache:'no-store',
        body: body?JSON.stringify(body):undefined
      });
      let data=null; try{ data=await res.json(); }catch{}
      if(!res.ok) throw (data?.error||'error');
      return data;
    }

    // Helpers de plan + fechas
    function getInterval(u){
      return (u?.subscription?.price?.interval ||
              u?.subscription?.plan?.interval ||
              u?.subscription_interval || 'month').toLowerCase();
    }
    function prettyPlan(u){
      const nick=(u?.subscription?.plan?.nickname || u?.subscription?.price?.nickname || '').toLowerCase();
      let base='Básico';
      if(/pro/.test(nick)) base='Pro';
      else if(/medio|standard|estándar/.test(nick)) base='Medio';
      else if(/basic|básico|basico/.test(nick)) base='Básico';
      const freq = getInterval(u)==='year' ? 'anual' : 'mensual';
      return `${base} ${freq}`;
    }
    function addDays(date, days){ const x=new Date(date); x.setDate(x.getDate()+days); return x; }
    function computeNextRenewal30(u){
      const start = u?.subscription?.current_period_start || u?.subscription_start || u?.subscription_created;
      if(!start) return null;
      const startDate = typeof start==='number' ? new Date(start*1000) : new Date(start);
      return getInterval(u)==='year' ? addDays(startDate,365) : addDays(startDate,30);
    }
    const fmtDate = (d)=> new Intl.DateTimeFormat('es-ES',{dateStyle:'medium'}).format(d);

    function prettySubLine(u){
      const st=(u?.subscription?.status||'').toLowerCase();
      if(!st) return 'Sin suscripción';
      const flags=[];
      if(u?.subscription?.cancel_at_period_end) flags.push('<span class="tag warn">Cancela al final de periodo</span>');
      $('#flags').innerHTML = flags.join(' ');
      return `${prettyPlan(u)} · estado: ${st}`;
    }

    let USER=null;

    async function refreshUser(paintOnly=false){
      const d = await api('GET','/api/session');
      const u = d?.user;
      if(!u){ alert('Inicia sesión para gestionar tu suscripción.'); location.href='suscripciones.html#cuenta'; return; }
      USER=u;

      $('#email').textContent=u.email||'—';
      $('#subLine').innerHTML = prettySubLine(u);
      $('#nfcQty').textContent = Number(u.nfc_qty||0);

      const next = computeNextRenewal30(u);
      $('#renewLine').textContent = next ? ('Renovación / fin de periodo: '+fmtDate(next)) : '';

      const st=(u?.subscription?.status||'').toLowerCase();
      const cancelAtEnd=!!u?.subscription?.cancel_at_period_end;

      // Botones
      if(st==='active' || st==='trialing' || st==='past_due'){
        $('#btnCancel').style.display = cancelAtEnd ? 'none' : 'inline-flex';
        $('#btnResume').style.display = cancelAtEnd ? 'inline-flex' : 'none';
      }else{
        $('#btnCancel').style.display='none';
        $('#btnResume').style.display='none';
      }

      if(!paintOnly){ $('#msg').textContent=''; }
    }

    // Ejecuta fallback de post-pago si venimos de Stripe con ?session_id=...
    async function runPostPagoIfNeeded(){
      const qs = new URLSearchParams(location.search);
      const sid = qs.get('session_id');
      if(!sid) return;
      try{ await api('POST','/api/post-pago',{ session_id: sid }); await refreshUser(true); }
      catch(e){ /* silencioso */ }
      // Limpia el parámetro de la URL
      try{
        qs.delete('session_id');
        const url = location.pathname + (qs.toString()?('?'+qs.toString()):'');
        history.replaceState({}, '', url);
      }catch{}
    }

    // Portal (alias estable). Si falla, mostramos instrucción
    async function openPortal(){
      try{
        const r=await api('POST','/api/create-portal-session',{});
        if(r?.url) location.href=r.url; else throw 'portal_unavailable';
      }catch(e){
        $('#msg').innerHTML = 'No se pudo abrir el portal. <span class="err">Revisa que estés logueado y las variables STRIPE estén configuradas.</span>';
        alert('No se pudo abrir el portal');
      }
    }

    // Acciones
    $('#btnPortal').addEventListener('click', openPortal);
    $('#changePlan').addEventListener('click', openPortal);
    $('#updateCard').addEventListener('click', openPortal);
    $('#invoices').addEventListener('click', openPortal);

    // Cancelar al final del periodo (sin portal)
    $('#btnCancel').addEventListener('click', async ()=>{
      try{
        await api('POST','/api/subscription/cancel',{ at_period_end:true });
        $('#msg').innerHTML = '<span class="warn">Tu suscripción seguirá activa hasta fin de periodo.</span>';
        await refreshUser();
      }catch(e){
        alert('No se pudo cancelar. Abriremos el portal.'); openPortal();
      }
    });

    // Reanudar (quitar cancel_at_period_end)
    $('#btnResume').addEventListener('click', async ()=>{
      try{
        await api('POST','/api/subscription/resume',{});
        $('#msg').innerHTML = '<span class="ok">La suscripción seguirá renovándose.</span>';
        await refreshUser();
      }catch(e){
        alert('No se pudo reanudar. Abriremos el portal.'); openPortal();
      }
    });

    // NFC
    $('#buyNfc').addEventListener('click', async ()=>{
      const q = Math.max(1, Math.min(999, parseInt($('#nfcCount').value||'1',10)||1));
      try{
        const r = await api('POST','/api/buy-nfc',{quantity:q});
        if(r?.url) location.href=r.url; else alert('No se pudo iniciar la compra.');
      }catch{ alert('No se pudo iniciar la compra.'); }
    });

    // Logout
    $('#logout').addEventListener('click', async ()=>{
      try{ await api('POST','/api/logout',{});}catch{}
      location.href='suscripciones.html#cuenta';
    });

    (async function init(){
      // Si venimos de Stripe, suma NFC / cierra ciclo
      await runPostPagoIfNeeded();
      await refreshUser();
    })();
  </script>
</body>
</html>

