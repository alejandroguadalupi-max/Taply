<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Gestionar suscripción — Taply</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b0f1a; --card:#0e1424; --txt:#e9eefc; --muted:#9fb0c6; --b:rgba(255,255,255,.12);
           --brand1:#00d4ff; --brand2:#7c3aed; --ok:#22c55e; --warn:#f59e0b; }
    *{box-sizing:border-box} html,body{height:100%} html{-webkit-text-size-adjust:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui}
    .wrap{width:min(900px,94%);margin:32px auto}
    .card{background:var(--card);border:1px solid var(--b);border-radius:18px;padding:22px;margin-bottom:16px}
    h1{margin:0 0 10px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border:0;border-radius:999px;font-weight:800;cursor:pointer;background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#061017}
    .ghost{padding:10px 14px;border:1px solid var(--b);border-radius:999px;background:transparent;color:inherit}
    .muted{color:var(--muted)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:780px){ .grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>Gestionar suscripción</h1>
      <div class="row">
        <a class="ghost" href="suscripciones.html">Volver a suscripciones</a>
        <button id="logout" class="ghost">Cerrar sesión</button>
      </div>
    </div>

    <section class="card" id="acctBox">
      <h2 style="margin:0 0 6px">Tu cuenta</h2>
      <p class="muted" id="email">—</p>
      <div class="grid2">
        <div>
          <h3>Suscripción</h3>
          <p id="subLine" class="muted">Cargando…</p>
          <p id="renewLine" class="muted"></p>
          <div class="row" style="margin-top:8px">
            <button id="btnCancel" class="ghost">Cancelar al final del periodo</button>
            <button id="btnResume" class="ghost" style="display:none">Reanudar</button>
            <button id="btnPortal" class="btn">Abrir portal</button>
          </div>
        </div>
        <div>
          <h3>NFC</h3>
          <p class="muted">Has comprado: <strong id="nfcQty">0</strong> dispositivos.</p>
          <div class="row">
            <input id="nfcCount" type="number" min="1" max="999" step="1" value="5" style="background:#0a0f16;border:1px solid var(--b);color:inherit;border-radius:12px;padding:10px;width:120px">
            <button id="buyNfc" class="btn">Comprar más NFC</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 6px">Acciones rápidas</h3>
      <div class="row">
        <button id="changePlan" class="ghost">Cambiar de plan</button>
        <button id="updateCard" class="ghost">Actualizar tarjeta</button>
        <button id="invoices" class="ghost">Ver facturas</button>
      </div>
      <p class="muted" style="margin-top:8px">Estas acciones se abren en el portal de Stripe.</p>
    </section>
  </main>

  <script>
    const $=s=>document.querySelector(s);
    const fmtDate = ts => { try{ const d = typeof ts==='number' && ts < 2e10 ? new Date(ts*1000) : new Date(ts); return new Intl.DateTimeFormat('es-ES',{dateStyle:'medium'}).format(d);}catch{return '';} };

    async function api(method, url, body){
      const res = await fetch(url,{method,headers:{'Content-Type':'application/json'},body: body?JSON.stringify(body):undefined});
      let data=null; try{ data=await res.json(); }catch{}
      if(!res.ok) throw (data?.error||'error');
      return data;
    }

    function prettySub(u){
      const st=(u?.subscription?.status||'').toLowerCase();
      const nick=u?.subscription?.plan?.nickname || u?.subscription?.price?.nickname || '—';
      const interval=u?.subscription?.price?.interval || 'month';
      if(!st) return 'Sin suscripción';
      const niceInt = interval==='year'?'Anual':'Mensual';
      return `${nick} · ${niceInt} · estado: ${st}`;
    }

    async function load(){
      const d = await api('GET','/api/session');
      const u = d?.user;
      if(!u){ location.href='acceso.html'; return; }
      $('#email').textContent=u.email||'—';
      $('#subLine').textContent = prettySub(u);
      $('#nfcQty').textContent = u.nfc_qty ?? 0;
      const end = u.current_period_end || u.subscription?.current_period_end;
      if(end) $('#renewLine').textContent='Renovación / fin de periodo: '+fmtDate(end);

      const st=(u?.subscription?.status||'').toLowerCase();
      if(st==='active' || st==='trialing' || st==='past_due'){
        $('#btnCancel').style.display='inline-flex';
        $('#btnResume').style.display='none';
      }else if(st==='canceled'){
        $('#btnCancel').style.display='none';
        $('#btnResume').style.display='inline-flex';
      }
    }

    // Portal
    async function openPortal(){ try{ const r=await api('POST','/api/create-portal-session',{}); if(r?.url) location.href=r.url; }catch{ alert('No se pudo abrir el portal'); } }

    // Cancelar / Reanudar
    $('#btnCancel').addEventListener('click', async ()=>{
      if(!confirm('Cancelar al final del periodo actual?')) return;
      try{ await api('POST','/api/subscription/cancel',{ at_period_end:true }); alert('Cancelación programada.'); location.reload(); }
      catch(e){ alert('No se pudo cancelar: '+e); }
    });
    $('#btnResume').addEventListener('click', async ()=>{
      try{ await api('POST','/api/subscription/resume',{}); alert('Suscripción reanudada.'); location.reload(); }
      catch(e){ alert('No se pudo reanudar: '+e); }
    });

    // Acciones portal
    $('#btnPortal').addEventListener('click', openPortal);
    $('#changePlan').addEventListener('click', openPortal);
    $('#updateCard').addEventListener('click', openPortal);
    $('#invoices').addEventListener('click', openPortal);

    // NFC
    $('#buyNfc').addEventListener('click', async ()=>{
      const q = Math.max(1, Math.min(999, parseInt($('#nfcCount').value||'1',10)||1));
      try{
        const r = await api('POST','/api/buy-nfc',{quantity:q});
        if(r?.url) location.href=r.url;
      }catch(e){ alert('No se pudo iniciar la compra: '+e); }
    });

    // Logout
    $('#logout').addEventListener('click', async ()=>{ try{ await api('POST','/api/logout',{});}catch{} location.href='acceso.html'; });

    load();
  </script>
</body>
</html>
