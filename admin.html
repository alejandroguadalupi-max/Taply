<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Admin — Taply</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b0f1a; --card:#0e1424; --txt:#e9eefc; --muted:#9fb0c6; --b:rgba(255,255,255,.12);
           --brand1:#00d4ff; --brand2:#7c3aed; }
    *{box-sizing:border-box} html,body{height:100%} html{-webkit-text-size-adjust:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui}
    .wrap{width:min(900px,94%);margin:28px auto}
    .card{background:var(--card);border:1px solid var(--b);border-radius:18px;padding:18px;margin-bottom:16px}
    h1{margin:0 0 10px}
    label{display:grid;gap:6px;margin:8px 0}
    input{background:#0a0f16;border:1px solid var(--b);color:inherit;border-radius:12px;padding:10px;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border:0;border-radius:999px;font-weight:800;cursor:pointer;background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#061017}
    .ghost{padding:10px 14px;border:1px solid var(--b);border-radius:999px;background:transparent;color:inherit}
    .muted{color:var(--muted)}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Panel de administración</h1>

    <section class="card">
      <h3>Clave de admin</h3>
      <div class="row">
        <input id="admKey" type="password" placeholder="ADMIN_KEY" style="min-width:280px">
        <button class="ghost" id="saveKey">Guardar</button>
        <span class="muted">Se guarda en localStorage para tus peticiones.</span>
      </div>
    </section>

    <section class="card">
      <h3>Buscar cliente</h3>
      <div class="row">
        <input id="email" type="email" placeholder="email@cliente.com" style="min-width:280px">
        <input id="custId" type="text" placeholder="cus_XXXX (opcional)" style="min-width:280px">
        <button id="find" class="btn">Buscar</button>
      </div>
      <p id="findErr" class="muted" style="display:none;color:#fca5a5"></p>
    </section>

    <section id="result" class="card" style="display:none">
      <h3 id="userTitle" style="margin:0 0 8px">Cliente</h3>
      <div class="kv"><div>Email</div><div id="rEmail" class="mono">—</div></div>
      <div class="kv"><div>Nombre</div><div id="rName">—</div></div>
      <div class="kv"><div>Customer ID</div><div id="rId" class="mono">—</div></div>
      <div class="kv"><div>Teléfono</div><div id="rPhone" class="mono">—</div></div>

      <h4 style="margin:14px 0 6px">Suscripción</h4>
      <div class="kv"><div>Estado</div><div id="rSubState">—</div></div>
      <div class="kv"><div>Plan</div><div id="rPlan">—</div></div>
      <div class="kv"><div>Intervalo</div><div id="rInterval">—</div></div>
      <div class="kv"><div>Inicio periodo</div><div id="rStart">—</div></div>
      <div class="kv"><div>Fin periodo</div><div id="rEnd">—</div></div>

      <h4 style="margin:14px 0 6px">NFC</h4>
      <div class="kv"><div>Comprados</div><div id="rNfc" class="mono">0</div></div>

      <div class="row" style="margin-top:12px">
        <button id="openPortal" class="btn">Abrir portal (cliente)</button>
        <input id="delta" type="number" step="1" value="1" min="0" style="width:120px">
        <button id="btnAddNfc" class="ghost">Sumar NFC</button>
        <input id="abs" type="number" step="1" value="0" min="0" style="width:120px">
        <button id="btnSetNfc" class="ghost">Establecer NFC</button>
        <button id="sendReset" class="ghost">Enviar reset password</button>
      </div>
    </section>
  </main>

  <script>
    const $=s=>document.querySelector(s);
    const fmtDate = ts => { try{ const d = typeof ts==='number' && ts < 2e10 ? new Date(ts*1000) : new Date(ts); return new Intl.DateTimeFormat('es-ES',{dateStyle:'medium'}).format(d);}catch{return '—';} };
    const KEYLS='taply_admin_key';

    function getKey(){ return localStorage.getItem(KEYLS)||''; }
    function setKey(v){ localStorage.setItem(KEYLS, v||''); }

    $('#admKey').value = getKey();
    $('#saveKey').addEventListener('click', ()=>{ setKey($('#admKey').value.trim()); alert('Clave guardada'); });

    async function apiAdmin(path, body){
      const res = await fetch('/api/'+path, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-Admin-Key': getKey() },
        body: JSON.stringify(body||{})
      });
      let data=null; try{ data=await res.json(); }catch{}
      if(!res.ok) throw (data?.error || ('HTTP '+res.status));
      return data;
    }

    function paint(result){
      const c = result.customer, s = result.subscription || {};
      $('#result').style.display='block';
      $('#userTitle').textContent = c.name || c.email || c.id;
      $('#rEmail').textContent = c.email || '—';
      $('#rName').textContent = c.name || '—';
      $('#rId').textContent = c.id || '—';
      $('#rPhone').textContent = c.phone || '—';

      $('#rSubState').textContent = s?.status || '—';
      $('#rPlan').textContent = s?.plan?.nickname || '—';
      $('#rInterval').textContent = s?.price?.interval || '—';
      $('#rStart').textContent = s?.current_period_start ? fmtDate(s.current_period_start) : '—';
      $('#rEnd').textContent = s?.current_period_end ? fmtDate(s.current_period_end) : '—';

      $('#rNfc').textContent = Number(c?.metadata?.taply_nfc_qty || 0);

      // actions
      $('#openPortal').onclick = async ()=>{
        try{ const r=await apiAdmin('admin/create-portal',{ customerId:c.id }); if(r?.url) location.href=r.url; }catch(e){ alert('No se pudo abrir el portal: '+e); }
      };
      $('#btnAddNfc').onclick = async ()=>{
        const delta = parseInt($('#delta').value||'0',10)||0;
        try{ const r=await apiAdmin('admin/add-nfc',{ customerId:c.id, delta }); $('#rNfc').textContent = r.nfc_qty; alert('Actualizado'); }catch(e){ alert('Error al sumar: '+e); }
      };
      $('#btnSetNfc').onclick = async ()=>{
        const qty = Math.max(0, parseInt($('#abs').value||'0',10)||0);
        try{ const r=await apiAdmin('admin/set-nfc',{ customerId:c.id, qty }); $('#rNfc').textContent = r.nfc_qty; alert('Guardado'); }catch(e){ alert('Error al establecer: '+e); }
      };
      $('#sendReset').onclick = async ()=>{
        try{ await fetch('/api/request-password-reset',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email: c.email }) }); alert('Enviado (si existe)'); }catch{ alert('Intento de envío realizado'); }
      };
    }

    $('#find').addEventListener('click', async ()=>{
      $('#findErr').style.display='none';
      try{
        const email = $('#email').value.trim();
        const customerId = $('#custId').value.trim();
        const r = await apiAdmin('admin/find', email ? { email } : { customerId });
        paint(r);
      }catch(e){
        $('#result').style.display='none';
        const err = (''+e) || 'error';
        $('#findErr').textContent = err;
        $('#findErr').style.display='block';
      }
    });
  </script>
</body>
</html>
