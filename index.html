<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>Taply — Sube la valoración de tu negocio sin esfuerzo</title>
  <meta name="description" content="Sé un imán de clientes con Taply: más y mejores reseñas online con tecnología NFC. Convierte opiniones positivas en reseñas de Google y aprende de las negativas." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f1a; --bg-2:#0e1424; --txt:#e9eefc; --muted:#94a3b8;
      --brand-1:#00d4ff; --brand-2:#7c3aed;
      --radius:20px; --shadow:0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
      --arrowSize:56px; --edgePad:calc(var(--arrowSize) + 28px);
      --border:rgba(255,255,255,.10);
      --ok:#22c55e; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;scroll-behavior:smooth}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--txt);
      opacity:0; transform:translateY(4px);
      transition:opacity .35s ease, transform .35s ease;
    }
    body.is-loaded{opacity:1;transform:none}
    a{color:inherit;text-decoration:none}
    .container{width:min(1200px,92%);margin-inline:auto}

    /* Fondo */
    body::before{content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;background-image:radial-gradient(rgba(255,255,255,.08) 1px, transparent 1.6px);background-size:26px 26px;opacity:.12}
    body::after{content:"";position:fixed;inset:-10%;z-index:-1;pointer-events:none;background:
      radial-gradient(circle at 12% 18%, rgba(255,255,255,.9) 1.2px, transparent 1.6px),
      radial-gradient(circle at 28% 72%, rgba(255,255,255,.9) 1.2px, transparent 1.6px),
      radial-gradient(circle at 45% 25%, rgba(255,255,255,.9) 1.4px, transparent 1.8px),
      radial-gradient(circle at 63% 66%, rgba(255,255,255,.9) 1.2px, transparent 1.6px),
      radial-gradient(circle at 80% 30%, rgba(255,255,255,.9) 1.3px, transparent 1.7px),
      radial-gradient(circle at 14% 88%, rgba(255,255,255,.9) 1.1px, transparent 1.5px),
      radial-gradient(circle at 88% 84%, rgba(255,255,255,.9) 1.2px, transparent 1.6px),
      radial-gradient(circle at 6% 52%,  rgba(255,255,255,.9) 1.3px, transparent 1.7px);
      background-repeat:no-repeat;filter:drop-shadow(0 0 6px rgba(255,255,255,.22));opacity:.28}

    /* Header */
    header{position:sticky;top:0;z-index:60;background:#0a0f16cc;border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(10px)}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:14px 0; position:relative}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;letter-spacing:.3px}
    .brand-logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand-1),var(--brand-2));display:grid;place-items:center;box-shadow:0 8px 22px rgba(124,58,237,.35)}
    .brand-logo svg{width:20px;height:20px}
    .nav-links{display:flex;gap:22px;align-items:center}
    .ghost{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:var(--txt)}
    .menu{display:none}

    /* Menú móvil */
    .mobile-menu{position:absolute; left:0; right:0; top:100%; display:none; padding:14px; background:#0b0f1a; border-top:1px solid rgba(255,255,255,.08); box-shadow:0 16px 40px rgba(0,0,0,.45)}
    .mobile-links{display:flex;flex-direction:column;gap:10px}
    .mobile-links .ghost{background:rgba(255,255,255,.02); border-color:rgba(255,255,255,.18)}
    .mobile-links .btn{width:100%; justify-content:center}

    /* Botón */
    .btn{
      --p:14px 18px; background:linear-gradient(135deg,var(--brand-1),var(--brand-2));
      color:#061017;font-weight:700;border:0;border-radius:999px;cursor:pointer;
      padding:var(--p);display:inline-flex;align-items:center;gap:8px;
      box-shadow:0 10px 30px rgba(124,58,237,.35), 0 4px 14px rgba(0,212,255,.25);
      position:relative; overflow:hidden; transform:translateZ(0);
      transition:transform .15s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:hover{ transform:translateY(-2px) }
    .btn:active{ transform:translateY(0); filter:saturate(1.1) }
    .btn::before{content:""; position:absolute; inset:-2px; background:linear-gradient(120deg, rgba(255,255,255,0) 35%, rgba(255,255,255,.35) 48%, rgba(255,255,255,0) 62%); transform:translateX(-120%); transition:transform .5s ease; mix-blend-mode:overlay}
    .btn:hover::before{ transform:translateX(120%) }
    .btn .ripple{position:absolute; border-radius:50%; transform:translate(-50%,-50%); background:rgba(255,255,255,.45); pointer-events:none; animation:ripple .6s ease forwards; mix-blend-mode:soft-light}
    @keyframes ripple{from{width:0;height:0;opacity:.6}to{width:420px;height:420px;opacity:0}}

    /* Tipografía y hero */
    .hero{padding:64px 0 40px; text-align:center}
    .hero-grid{display:grid;grid-template-columns:1fr;gap:18px;justify-items:center}
    h1,h2,h3,p{ text-align:center }
    h1{font-size:clamp(2rem,4.5vw,3.2rem);line-height:1.1;margin:10px 0 6px}
    .lead{color:var(--muted);font-size:1.05rem;max-width:900px;margin:0 auto}
    .cta-row{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin-top:18px}
    .pills{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);padding:10px 14px;border-radius:999px}

    /* Secciones */
    section{padding:56px 0}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    .card{background:var(--bg-2);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);text-align:center}
    .card h3{margin:.2rem 0 .6rem}
    .card p{color:var(--muted);margin:0}

    /* Opiniones */
    .reviews{position:relative;margin:36px 0}
    .reviews h2{margin:0 0 14px}
    .reviews-window{position:relative;overflow:hidden}
    .reviews-window::before,.reviews-window::after{content:"";position:absolute;top:0;bottom:0;width:calc(var(--edgePad) - 8px);pointer-events:none;z-index:3;background:linear-gradient(90deg, rgba(11,15,26,1) 0%, rgba(11,15,26,.7) 55%, rgba(11,15,26,0) 100%)}
    .reviews-window::before{ left:0 } .reviews-window::after{ right:0; transform:scaleX(-1) }
    .reviews-track{display:flex;gap:22px;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding:0 var(--edgePad);scroll-padding:0 var(--edgePad);scrollbar-width:none;overscroll-behavior-x: contain; touch-action: pan-y;}
    .reviews-track::-webkit-scrollbar{display:none}
    .review-card{flex:0 0 clamp(360px, 40vw, 480px);max-width:520px;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:20px;scroll-snap-align:center;scroll-snap-stop:normal;text-align:left;box-shadow:0 20px 50px rgba(0,0,0,.35);transition:transform .2s ease,border-color .2s ease}
    .review-card:hover{ transform:translateY(-2px); border-color:rgba(255,255,255,.16) }
    .review-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .review-avatar{width:54px;height:54px;border-radius:999px;overflow:hidden;flex:0 0 54px;border:1px solid rgba(255,255,255,.14);box-shadow:0 10px 22px rgba(124,58,237,.25)}
    .review-avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .review-name{font-weight:700}.review-stars{color:#fbbf24;font-size:18px;letter-spacing:2px}
    .review-text{color:#c9d3e6;margin:6px 0 12px}

    /* FAQ */
    .faq{max-width:900px;margin-inline:auto}
    .acc{border:1px solid rgba(255,255,255,.10);border-radius:16px;overflow:hidden;background:rgba(255,255,255,.02);box-shadow:var(--shadow)}
    .acc-item + .acc-item{border-top:1px solid rgba(255,255,255,.08)}
    .acc-btn{width:100%;background:transparent;border:0;color:var(--txt);padding:18px 20px;font-size:1rem;font-weight:700;display:flex;justify-content:center;align-items:center;gap:10px;text-align:center}
    .acc-panel{max-height:0;overflow:hidden;transition:max-height .3s ease}
    .acc-panel > div{padding:0 20px 18px;color:var(--muted);text-align:center}

    /* Footer */
    footer{padding:40px 0;color:#b7c3d2;border-top:1px solid rgba(255,255,255,.06)}
    footer .cols{display:grid;grid-template-columns:2fr 1fr 1fr;gap:20px}
    footer a{color:#dbeafe}
    footer p{text-align:center}

    /* Sociales */
    .socials{padding:24px 0 16px;border-top:1px solid rgba(255,255,255,.06)}
    .socials .row{display:flex;justify-content:center;gap:18px}
    .socials a{width:54px;height:54px;border-radius:999px;display:grid;place-items:center;border:1px solid rgba(255,255,255,.25);color:#fff;opacity:.95;transition:transform .15s ease, opacity .2s ease, border-color .2s ease}
    .socials a:hover{transform:translateY(-2px);opacity:1;border-color:#fff}

    /* Cookie bar */
    .cookiebar{position:fixed;left:0;right:0;bottom:0;z-index:50;background:#0a0f16;color:#dbeafe;border-top:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:14px;justify-content:space-between;padding:12px 16px}
    .cookiebar p{margin:0;font-size:.95rem;text-align:left}
    .cookiebar .btn-accept{background:#6366f1;border:0;color:#fff;border-radius:8px;padding:8px 16px;cursor:pointer}

    /* Panel "Mi suscripción" (separado de planes/NFC) */
    .account{background:var(--bg-2);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:22px;margin-top:18px}
    .account .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
    .badge{display:inline-block;font-size:.82rem;font-weight:800;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;background:rgba(255,255,255,.04);color:#cfe3ff;margin-bottom:10px}
    .mini{font-size:.92rem;color:#9fb0c6}

    /* Modal auth */
    .modal{position:fixed;inset:0;display:none;place-items:center;z-index:80}
    .overlay{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px)}
    .dialog{position:relative;width:min(480px,92%);background:#0c1326;border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 30px 80px rgba(0,0,0,.5);padding:18px}
    .dialog h3{margin:0 0 4px;text-align:left}
    .dialog p{margin:0 0 14px;text-align:left;color:#b9c6db}
    .x{position:absolute;top:10px;right:10px;background:transparent;border:0;color:#cbd5e1;font-size:20px;cursor:pointer}
    .prov{display:flex;flex-direction:column;gap:10px;margin:10px 0 14px}
    .btn-line{display:flex;align-items:center;gap:10px;justify-content:center;background:#111a34;border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn-line:hover{filter:brightness(1.08)}
    .btn-line img{width:18px;height:18px}
    form.auth{display:grid;grid-template-columns:1fr;gap:10px;margin-top:6px}
    input[type="email"], input[type="text"]{background:#0b1430;border:1px solid rgba(255,255,255,.14);color:#e9eefc;padding:10px 12px;border-radius:10px;outline:none}
    .hint{font-size:.85rem;color:#8fa0bb}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:90;display:none;background:#0f172a;border:1px solid rgba(255,255,255,.12);color:#e5edff;padding:10px 14px;border-radius:10px}

    /* Móvil */
    @media (max-width: 768px){
      :root{ --arrowSize:48px; --edgePad:72px; }
      section{padding:48px 0}
      header{background:#0a0f16}
      .grid-3{grid-template-columns:1fr}
      .nav-links{display:none}
      .menu{
        display:block;
        background:#0f172a; color:#e9eefc;
        border:1px solid rgba(255,255,255,.28);
        box-shadow:0 8px 24px rgba(0,0,0,.45);
        padding:10px 14px; border-radius:999px;
      }
      .menu:hover{filter:brightness(1.08)}
      .menu:active{transform:translateY(1px)}
      .cookiebar{flex-direction:column;align-items:flex-start;gap:10px}
    }

    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important}
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header>
    <div class="container nav">
      <a class="brand" href="#top">
        <span class="brand-logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M5 12a7 7 0 1114 0v6.5a2.5 2.5 0 01-5 0V9.75a2.25 2.25 0 10-4.5 0V18.5a2.5 2.5 0 01-5 0V12z" stroke="#061017" stroke-width="1.7"/></svg>
        </span>
        <span>taply</span>
      </a>
      <nav class="nav-links">
        <a class="ghost" href="#beneficios">Beneficios</a>
        <a class="ghost" href="#como-funciona">Cómo funciona</a>
        <a class="ghost" href="#reviews">Opiniones</a>
        <!-- NUEVA ENTRADA: MI SUSCRIPCIÓN (protegida) -->
        <a class="ghost" href="#mi-suscripcion" data-requires-auth id="navAccount">Mi suscripción</a>
        <button class="btn" id="btnAbrirLogin">Iniciar sesión</button>
      </nav>
      <button class="menu ghost" id="menuBtn" aria-expanded="false" aria-controls="mobileMenu">Menú</button>
    </div>

    <!-- MENÚ MÓVIL -->
    <div class="container mobile-menu" id="mobileMenu" role="menu" aria-label="Menú móvil">
      <div class="mobile-links">
        <a class="ghost" href="#beneficios" role="menuitem">Beneficios</a>
        <a class="ghost" href="#como-funciona" role="menuitem">Cómo funciona</a>
        <a class="ghost" href="#reviews" role="menuitem">Opiniones</a>
        <a class="ghost" href="#mi-suscripcion" data-requires-auth role="menuitem">Mi suscripción</a>
        <a class="btn" id="btnAbrirLoginMobile" role="menuitem">Iniciar sesión</a>
      </div>
    </div>
  </header>

  <main id="top">
    <!-- HERO -->
    <section class="hero">
      <div class="container hero-grid">
        <div>
          <h1>¿Imaginas subir la valoración de tu negocio <em>SIN HACER NADA</em>?</h1>
          <p class="lead">Aumenta tus reseñas, protege tu reputación y convierte opiniones en más clientes y más ingresos, sin mover un solo dedo.</p>
          <div class="pills" aria-label="Resultados clave">
            <div class="pill">Mejores reseñas en internet</div><div class="pill">Más clientes</div><div class="pill">Más dinero</div>
          </div>
          <div class="cta-row"><a class="btn" href="#beneficios">Ver cómo funciona</a></div>
        </div>
      </div>
    </section>

    <!-- BENEFICIOS -->
    <section id="beneficios">
      <div class="container">
        <h2>¿Qué podrás conseguir gracias a nuestro sistema?</h2>
        <p class="lead">En Taply te aseguramos conseguir <strong>mejores reseñas</strong>, atraer <strong>más clientes</strong> y generar <strong>más ingresos</strong>, mientras escuchas de verdad a tus clientes.</p>
        <div class="grid-3" style="margin-top:20px">
          <article class="card"><h3>Crea un clima donde la opinión importa</h3><p>Tus clientes dejan su reseña con solo acercar el móvil al dispositivo. Sencillo, rápido y sin fricción.</p></article>
          <article class="card"><h3>Encuentra los puntos débiles</h3><p>Las reseñas negativas no se publican: se guardan en tu panel para analizarlas, filtrarlas por periodo y mejorar.</p></article>
          <article class="card"><h3>Gana dinero</h3><p>Con mejores valoraciones subes posiciones en el buscador, atraes más clientes y aumentas beneficios.</p></article>
        </div>
      </div>
    </section>

    <!-- OPINIONES -->
    <section class="reviews" id="reviews">
      <div class="container">
        <h2>Valorado 4,8/5 por más de 30 negocios</h2>
        <div class="reviews-window">
          <div class="reviews-track" id="reviewsTrack" tabindex="0" aria-label="Opiniones de clientes">
            <article class="review-card">
              <div class="review-header">
                <div class="review-avatar"><img src="https://i.pravatar.cc/110?img=26" alt="Sara Cordero" width="54" height="54"></div>
                <div><div class="review-name">Sara Cordero</div><div class="review-stars">★★★★★</div></div>
              </div>
              <p class="review-text">Instalación en 5 minutos. Los avisos de reseñas negativas nos han permitido corregir fallos de atención al cliente en días.</p>
            </article>
            <article class="review-card">
              <div class="review-header">
                <div class="review-avatar"><img src="https://i.pravatar.cc/110?img=33" alt="Marlon Melara" width="54" height="54"></div>
                <div><div class="review-name">Marlon Melara</div><div class="review-stars">★★★★★</div></div>
              </div>
              <p class="review-text">Una herramienta genial para ahorrar tiempo en reputación online. Muy fácil para el cliente.</p>
            </article>
            <article class="review-card">
              <div class="review-header">
                <div class="review-avatar"><img src="https://i.pravatar.cc/110?img=12" alt="Joan Blanch" width="54" height="54"></div>
                <div><div class="review-name">Joan Blanch</div><div class="review-stars">★★★★★</div></div>
              </div>
              <p class="review-text">Llevamos semanas subiendo reseñas sin pedirlo. El panel de negativas nos ayudó a mejorar procesos.</p>
            </article>
            <article class="review-card">
              <div class="review-header">
                <div class="review-avatar"><img src="https://i.pravatar.cc/110?img=5" alt="Eco Abraham" width="54" height="54"></div>
                <div><div class="review-name">Eco Abraham</div><div class="review-stars">★★★★★</div></div>
              </div>
              <p class="review-text">Nunca tantas reseñas reales tan rápido. El flujo NFC es comodísimo.</p>
            </article>
          </div>
          <div class="reviews-nav" aria-hidden="true">
            <button class="nav-btn" id="revPrev" aria-label="Anterior">‹</button>
            <button class="nav-btn" id="revNext" aria-label="Siguiente">›</button>
          </div>
        </div>
      </div>
    </section>

    <!-- COMO FUNCIONA -->
    <section id="como-funciona">
      <div class="container"><h2>Ahora bien... ¿Cómo funciona Taply?</h2></div>
      <div class="container grid-3">
        <div class="card"><h3>1) Acerca el móvil</h3><p>Coloca los dispositivos <strong>Taply</strong> en las mesas. El cliente acerca su smartphone y aparece la pantalla de valoración sin apps.</p></div>
        <div class="card"><h3>2) Enrutado inteligente</h3><p>Si la experiencia es positiva, va a Google; si es negativa, se abre un formulario privado que guardamos para ti.</p></div>
        <div class="card"><h3>3) Aprende y mejora</h3><p>Verás negativas en una hoja privada con filtros por fecha/categoría para actuar rápido.</p></div>
      </div>
    </section>

    <!-- MI SUSCRIPCIÓN (zona independiente y protegida) -->
    <section id="mi-suscripcion">
      <div class="container">
        <h2>Mi suscripción</h2>
        <p class="lead">Aquí podrás ver/gestionar tu plan. <span class="mini">Para acceder debes iniciar sesión.</span></p>

        <!-- Si NO está logueado -->
        <div class="account" id="accountLocked">
          <span class="badge">Acceso restringido</span>
          <div class="row">
            <p class="mini">Debes iniciar sesión para ver tu suscripción.</p>
            <button class="btn" id="openLoginFromLocked">Iniciar sesión</button>
          </div>
        </div>

        <!-- Si SÍ está logueado -->
        <div class="account" id="accountPanel" style="display:none">
          <span class="badge">Mi cuenta</span>
          <div class="row">
            <div>
              <p style="margin:.2rem 0 0"><strong id="accEmail">—</strong></p>
              <p class="mini" id="accName" style="margin:.2rem 0 0"></p>
              <p class="mini" id="accStatus" style="margin:.4rem 0 0">Cargando estado de suscripción…</p>
            </div>
            <div class="row" style="gap:8px">
              <button class="ghost" id="logoutBtn">Cerrar sesión</button>
              <button class="btn" id="portalBtn">Gestionar suscripción</button>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- FOOTER -->
  <footer>
    <div class="container cols">
      <div>
        <div class="brand" style="margin-bottom:10px">
          <span class="brand-logo" aria-hidden="true"></span><span>taply</span>
        </div>
        <p style="color:#9fb0c8;max-width:560px">Tecnología NFC para convertir feedback en crecimiento real.</p>
      </div>
      <div>
        <p><a href="#beneficios">Beneficios</a></p>
        <p><a href="#como-funciona">Cómo funciona</a></p>
        <p><a href="#mi-suscripcion" data-requires-auth>Mi suscripción</a></p>
      </div>
      <div>
        <p><a href="#reviews">Opiniones</a></p>
        <p><a href="#top">Volver arriba</a></p>
      </div>
    </div>
  </footer>

  <!-- Cookie bar -->
  <div class="cookiebar" id="cookiebar" role="dialog" aria-live="polite" aria-label="Aviso de cookies">
    <p>Usamos cookies en nuestra página web para ver cómo interactúas con ella. Al aceptarlas, estás de acuerdo con nuestro uso de dichas cookies. <a href="#" style="color:#b3e1ff;text-decoration:underline">Política de privacidad</a></p>
    <button class="btn-accept" id="cookieAccept">Aceptar</button>
  </div>

  <!-- Modal de autenticación -->
  <div class="modal" id="authModal" aria-hidden="true" role="dialog" aria-labelledby="authTitle">
    <div class="overlay" data-close-modal></div>
    <div class="dialog">
      <button class="x" title="Cerrar" data-close-modal aria-label="Cerrar">×</button>
      <h3 id="authTitle">Inicia sesión</h3>
      <p>Usa Google o tu correo. Vincularemos tus pagos a este email.</p>
      <div class="prov">
        <button class="btn-line" id="googleBtn">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
          <span>Continuar con Google</span>
        </button>
      </div>
      <form class="auth" id="emailForm">
        <input type="email" id="emailInput" placeholder="tu@email.com" required>
        <input type="text" id="nameInput" placeholder="Nombre del negocio (opcional)">
        <button class="btn" type="submit">Continuar con correo</button>
      </form>
      <p class="hint">¿Problemas? También puedes entrar con correo. Si no hay servidor configurado, usaremos un modo seguro local (no se pierde al recargar).</p>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    /* ========= Utilidades/UI ========= */
    const $ = s => document.querySelector(s), $$ = s => document.querySelectorAll(s);
    const showToast = (msg) => { const t = $('#toast'); t.textContent = msg; t.style.display='block'; setTimeout(()=> t.style.display='none', 2600); };
    const showModal = (id)=>{ const m=$(id); if(!m) return; m.style.display='grid'; m.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; };
    const hideModal = (id)=>{ const m=$(id); if(!m) return; m.style.display='none'; m.setAttribute('aria-hidden','true'); document.body.style.overflow=''; };

    window.addEventListener('load', () => document.body.classList.add('is-loaded'));

    // Menú móvil
    const menuBtn = $('#menuBtn'); const mobileMenu = $('#mobileMenu');
    menuBtn?.addEventListener('click', ()=> {
      const open = mobileMenu.style.display === 'block';
      mobileMenu.style.display = open ? 'none' : 'block';
      menuBtn.setAttribute('aria-expanded', String(!open));
    });
    mobileMenu?.addEventListener('click', (e)=>{ const a = e.target.closest('a,button'); if(a){ mobileMenu.style.display='none'; menuBtn.setAttribute('aria-expanded','false'); }});
    window.addEventListener('resize', ()=>{ if(window.innerWidth > 768){ mobileMenu.style.display='none'; menuBtn.setAttribute('aria-expanded','false'); }});

    // Cookie bar
    (function(){
      const KEY='taply_cookie_consent';
      const bar=$('#cookiebar'), btn=$('#cookieAccept');
      if(localStorage.getItem(KEY)==='1'){ bar.style.display='none'; }
      btn.addEventListener('click',()=>{ localStorage.setItem(KEY,'1'); bar.style.display='none'; });
    })();

    // Ripple en .btn
    document.addEventListener('click',(e)=>{
      const b=e.target.closest('.btn'); if(!b) return;
      const r=document.createElement('span'); r.className='ripple';
      const rect=b.getBoundingClientRect();
      r.style.left=(e.clientX-rect.left)+'px'; r.style.top=(e.clientY-rect.top)+'px';
      b.appendChild(r); r.addEventListener('animationend',()=>r.remove());
    });

    // Carrusel opiniones
    (function(){
      const track=$('#reviewsTrack'), prev=$('#revPrev'), next=$('#revNext');
      if(!track||!prev||!next) return;
      const step=()=>{ const first=track.querySelector('.review-card'); const gap=parseInt(getComputedStyle(track).gap||'22',10); const width=first?Math.round(first.getBoundingClientRect().width):360; return width+gap; };
      const atStart=()=>track.scrollLeft<=2, atEnd=()=>track.scrollLeft+track.clientWidth>=track.scrollWidth-2;
      const update=()=>{ prev.classList.toggle('disabled',atStart()); next.classList.toggle('disabled',atEnd()); };
      prev.addEventListener('click',()=>{ if(!prev.classList.contains('disabled')) track.scrollBy({left:-step(),behavior:'smooth'}); });
      next.addEventListener('click',()=>{ if(!next.classList.contains('disabled')) track.scrollBy({left: step(),behavior:'smooth'}); });
      track.addEventListener('scroll',update,{passive:true}); window.addEventListener('resize',update); update();
    })();

    /* ========= Auth: API + Fallback sin “error de red” ========= */
    const AUTH_COOKIE = 'taply_session';
    const LOCAL_USER_KEY = 'taply_local_user'; // fallback local
    const parseCookie = (name)=>{
      const m = (document.cookie||'').match(new RegExp('(?:^|; )'+name+'=([^;]+)')); return m ? decodeURIComponent(m[1]) : null;
    };

    async function apiFetch(url, options={}){
      // Helper robusto: captura fallos y nunca revienta la UI
      const opts={credentials:'include', headers:{'Content-Type':'application/json', ...(options.headers||{})}, ...options};
      try{
        const res = await fetch(url, opts);
        const ct = res.headers.get('content-type')||'';
        const data = ct.includes('application/json') ? await res.json().catch(()=> ({})) : {};
        if(!res.ok) throw new Error(data.message || res.status+' '+res.statusText);
        return { ok:true, data };
      }catch(err){
        // No re-lanzamos para evitar “error de red”: devolvemos estado fallido
        return { ok:false, error: (err && err.message) || 'Error de red' };
      }
    }

    function getLocalUser(){
      try{ const raw = localStorage.getItem(LOCAL_USER_KEY); return raw ? JSON.parse(raw) : null; }catch{ return null; }
    }
    function setLocalUser(user){ try{ localStorage.setItem(LOCAL_USER_KEY, JSON.stringify(user||{})); }catch{} }
    function clearLocalUser(){ try{ localStorage.removeItem(LOCAL_USER_KEY); }catch{} }

    async function getSession(){
      // 1) Si el servidor existe, úsalo
      const me = await apiFetch('/api/auth/me', { method:'GET' });
      if(me.ok) return me.data;
      // 2) Si hay cookie, pero el endpoint falla, no podemos leerla -> caer a local
      const local = getLocalUser();
      return local || null;
    }

    async function loginWithEmail(email, name){
      // Intento real
      const r = await apiFetch('/api/auth/login', { method:'POST', body: JSON.stringify({email, name}) });
      if(r.ok){
        // servidor guardará cookie; por si acaso cacheamos también local
        setLocalUser({ email, name: name||'' });
        return true;
      }
      // Fallback local: sin servidor
      setLocalUser({ email, name: name||'' });
      showToast('Sesión iniciada en modo local.');
      return true;
    }

    async function logout(){
      const r = await apiFetch('/api/auth/logout', { method:'POST' });
      clearLocalUser();
      // Si había cookie, el servidor la borrará; no pasa nada si falla
      return true;
    }

    async function loginWithGoogle(){
      // Si existe endpoint para obtener URL de Google, úsalo
      const r = await apiFetch('/api/auth/google-url', { method:'POST' });
      if(r.ok && r.data && r.data.url){
        location.href = r.data.url; // flujo OAuth real
        return;
      }
      // Fallback: demo local
      setLocalUser({ email: 'demo.google@taply.local', name: 'Usuario Google' });
      showToast('Google no configurado: usando sesión local.');
      await onAuthChanged();
      hideModal('#authModal');
    }

    /* ========= Protección de la sección ========= */
    async function requireAuth(){
      const session = await getSession();
      if(session && session.email) return session;
      showModal('#authModal');
      return null;
    }

    async function onAuthChanged(){
      const session = await getSession();
      const locked = $('#accountLocked');
      const panel = $('#accountPanel');
      if(session && session.email){
        // Mostrar panel
        locked.style.display = 'none';
        panel.style.display = '';
        $('#accEmail').textContent = session.email || '—';
        $('#accName').textContent = session.name ? session.name : '';
        // Estado de suscripción (si hay backend). Si no, mostramos placeholder amigable
        const st = await apiFetch('/api/subscription/status', { method:'GET' });
        if(st.ok && st.data){
          if(st.data.active){
            $('#accStatus').innerHTML = `Plan: <strong>${st.data.tier||'—'}</strong> · ${st.data.interval||''} — <span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--ok')};font-weight:700">Activo</span>`;
          }else{
            $('#accStatus').textContent = 'Sin suscripción activa.';
          }
        }else{
          $('#accStatus').textContent = 'Sin suscripción activa (servidor no configurado).';
        }
        // Botón cabecera -> cambia a “Mi cuenta”
        $('#btnAbrirLogin')?.classList.add('ghost');
        $('#btnAbrirLogin')?.classList.remove('btn');
        $('#btnAbrirLogin')?.setAttribute('disabled','disabled');
      }else{
        locked.style.display = '';
        panel.style.display = 'none';
        $('#btnAbrirLogin')?.removeAttribute('disabled');
        $('#btnAbrirLogin')?.classList.remove('ghost');
        $('#btnAbrirLogin')?.classList.add('btn');
      }
    }

    /* ========= Eventos UI ========= */

    // Abrir login
    $('#btnAbrirLogin')?.addEventListener('click', ()=> showModal('#authModal'));
    $('#btnAbrirLoginMobile')?.addEventListener('click', ()=> showModal('#authModal'));
    $('#openLoginFromLocked')?.addEventListener('click', ()=> showModal('#authModal'));
    $$('#authModal [data-close-modal]').forEach(el=> el.addEventListener('click', ()=> hideModal('#authModal')));

    // Clicks en enlaces protegidos (Mi suscripción)
    $$('[data-requires-auth]').forEach(link=>{
      link.addEventListener('click', async (e)=>{
        // Evita saltos hasta verificar
        e.preventDefault();
        const session = await requireAuth();
        if(session){
          // Abre sección de cuenta
          document.getElementById('mi-suscripcion').scrollIntoView({behavior:'smooth', block:'start'});
        }
      });
    });

    // Form email
    $('#emailForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('#emailInput').value.trim();
      const name = $('#nameInput').value.trim();
      if(!email) return showToast('Introduce tu email');
      const ok = await loginWithEmail(email, name);
      if(ok){
        hideModal('#authModal');
        await onAuthChanged();
        document.getElementById('mi-suscripcion').scrollIntoView({behavior:'smooth', block:'start'});
      }
    });

    // Google
    $('#googleBtn')?.addEventListener('click', async ()=>{
      await loginWithGoogle();
    });

    // Logout
    $('#logoutBtn')?.addEventListener('click', async ()=>{
      await logout();
      await onAuthChanged();
      showToast('Sesión cerrada.');
    });

    // Portal de suscripción
    $('#portalBtn')?.addEventListener('click', async ()=>{
      const r = await apiFetch('/api/subscription/portal', { method:'POST' });
      if(r.ok && r.data && r.data.url){ location.href = r.data.url; }
      else showToast('Portal no disponible (servidor no configurado).');
    });

    // Inicializa estado
    (async ()=> { await onAuthChanged(); })();
  </script>
</body>
</html>
