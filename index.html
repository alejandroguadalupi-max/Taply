<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>Taply — Sube la valoración de tu negocio sin esfuerzo</title>
  <meta name="description" content="Sé un imán de clientes con Taply: más y mejores reseñas online con tecnología NFC. Convierte opiniones positivas en reseñas de Google y aprende de las negativas.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f1a; --bg-2:#0e1424; --txt:#e9eefc; --muted:#94a3b8;
      --brand-1:#00d4ff; --brand-2:#7c3aed;
      --blue-1:#38bdf8; --blue-2:#2563eb;
      --radius:20px; --shadow:0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
      --arrowSize:56px; --edgePad:calc(var(--arrowSize) + 36px); /* más margen para que no tape nada */
    }
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    html,body{margin:0;height:100%;scroll-behavior:smooth}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--txt);
      opacity:0; transform:translateY(4px);
      transition:opacity .35s ease, transform .35s ease;
    }
    body.is-loaded{opacity:1;transform:none}
    a{color:inherit;text-decoration:none}
    .container{width:min(1200px,92%);margin-inline:auto}
    body::before{content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;background-image:radial-gradient(rgba(255,255,255,.08) 1px, transparent 1.6px);background-size:26px 26px;opacity:.12}

    header{position:sticky;top:0;z-index:60;background:#0a0f16cc;border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(10px)}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:14px 0; position:relative}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;letter-spacing:.3px}
    .brand-logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand-1),var(--brand-2));display:grid;place-items:center;box-shadow:0 8px 22px rgba(124,58,237,.35)}
    .brand-logo svg{width:20px;height:20px}
    .nav-links{display:flex;gap:18px;align-items:center}
    .ghost{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:var(--txt);touch-action:manipulation}
    .menu{display:none}

    /* Cuenta */
    .acct-chip{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid rgba(255,255,255,.14);border-radius:999px;background:rgba(255,255,255,.04);cursor:pointer}
    .acct-avatar{width:28px;height:28px;border-radius:999px;background:linear-gradient(135deg,var(--brand-1),var(--brand-2));display:grid;place-items:center;font-weight:800;color:#061017}
    .acct-dd{position:relative}
    .acct-menu{position:absolute;right:0;top:110%;min-width:220px;background:#0b0f1a;border:1px solid rgba(255,255,255,.12);border-radius:14px;box-shadow:var(--shadow);display:none;padding:6px}
    .acct-menu a,.acct-menu button{display:flex;width:100%;text-align:left;background:transparent;border:0;color:inherit;padding:10px 12px;border-radius:10px;cursor:pointer}
    .acct-menu a:hover,.acct-menu button:hover{background:rgba(255,255,255,.06)}
    .acct-dd.open .acct-menu{display:block}

    .mobile-menu{position:absolute; left:0; right:0; top:100%; display:none; padding:14px; background:#0b0f1a; border-top:1px solid rgba(255,255,255,.08); box-shadow:0 16px 40px rgba(0,0,0,.45)}
    .mobile-links{display:flex;flex-direction:column;gap:10px}
    .mobile-links .ghost{background:rgba(255,255,255,.02); border-color:rgba(255,255,255,.18)}
    .mobile-links .btn{width:100%; justify-content:center}

    .btn{
      --p:14px 18px; background:linear-gradient(135deg,var(--brand-1),var(--brand-2));
      color:#061017;font-weight:700;border:0;border-radius:999px;cursor:pointer;touch-action:manipulation;
      padding:var(--p);display:inline-flex;align-items:center;gap:8px;
      box-shadow:0 10px 30px rgba(124,58,237,.35), 0 4px 14px rgba(0,212,255,.25);
      position:relative; overflow:hidden; transform:translateZ(0);
      transition:transform .15s ease, box-shadow .2s ease, filter .2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ transform:translateY(-2px) }
    .btn:active{ transform:translateY(0); filter:saturate(1.1) }
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.12);color:var(--txt);box-shadow:none}

    .hero{padding:64px 0 40px; text-align:center}
    .hero-grid{display:grid;grid-template-columns:1fr;gap:18px;justify-items:center}
    h1,h2,h3,p{ text-align:center }
    h1{font-size:clamp(2rem,4.5vw,3.2rem);line-height:1.1;margin:10px 0 6px}
    .lead{color:var(--muted);font-size:1.05rem;max-width:900px;margin:0 auto}
    .cta-row{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin-top:18px}
    .pills{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);padding:10px 14px;border-radius:999px}

    section{padding:56px 0}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    .card{background:var(--bg-2);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);text-align:center}
    .card h3{margin:.2rem 0 .6rem}
    .card p{color:var(--muted);margin:0}

    /* Reviews / carrusel */
    .reviews{position:relative;margin:36px 0}
    .reviews h2{margin:0 0 14px}

    .reviews-window{position:relative}
    .reviews-track{
      display:flex;gap:22px;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;
      padding:0 var(--edgePad);scroll-padding:0 var(--edgePad);scrollbar-width:none;
      overscroll-behavior-x: contain; touch-action: pan-y;
    }
    .reviews-track::-webkit-scrollbar{display:none}

    .review-card{
      flex:0 0 clamp(320px, 86vw, 520px);
      max-width:520px;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.1);
      border-radius:16px;padding:20px;scroll-snap-align:center;scroll-snap-stop:always;
      text-align:left;box-shadow:0 20px 50px rgba(0,0,0,.35);
    }
    .review-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .review-avatar{width:54px;height:54px;border-radius:999px;overflow:hidden;flex:0 0 54px;border:1px solid rgba(255,255,255,.14);box-shadow:0 10px 22px rgba(124,58,237,.25)}
    .review-name{font-weight:700}
    .review-stars{color:#fbbf24;font-size:18px;letter-spacing:2px}
    .review-text{color:#c9d3e6;margin:6px 0 12px}

    .carousel-btn{
      position:absolute;top:50%;transform:translateY(-50%);
      width:var(--arrowSize);height:var(--arrowSize);border-radius:999px;border:0;
      background:linear-gradient(135deg,var(--blue-1),var(--blue-2));color:#fff;cursor:pointer;
      display:grid;place-items:center;box-shadow:0 10px 30px rgba(37,99,235,.45),0 6px 18px rgba(56,189,248,.35);
      transition:filter .2s ease, transform .1s ease; z-index:2;
    }
    .carousel-btn:hover{ filter:brightness(1.1) }
    .carousel-btn:active{ transform:translateY(-50%) scale(.98) }
    .carousel-btn.left{left:10px}
    .carousel-btn.right{right:10px}
    .carousel-btn span{font-size:clamp(20px,3.8vw,26px);line-height:1}

    input,select,textarea,button{font-size:16px}
    :focus-visible{outline:2px solid #7c3aed; outline-offset:2px; border-radius:8px}

    @media (max-width: 768px){
      :root{ --arrowSize:44px; --edgePad:calc(var(--arrowSize) + 30px); }
      section{padding:48px 0}
      header{background:#0a0f16}
      .grid-3{grid-template-columns:1fr}
      .nav-links{display:none}
      .menu{
        display:block;background:#0f172a;color:#e9eefc;border:1px solid rgba(255,255,255,.28);
        box-shadow:0 8px 24px rgba(0,0,0,.45);padding:10px 14px;border-radius:999px;touch-action:manipulation;
      }
      .menu:hover{filter:brightness(1.08)}
      .menu:active{transform:translateY(1px)}
    }
    @media (max-width:480px){
      /* en móviles muy pequeños, ocultamos flechas y dejamos swipe */
      .carousel-btn{display:none}
      .reviews-track{padding:0 18px}
    }
    @media (prefers-reduced-motion: reduce){ *{animation:none!important;transition:none!important} }

    /* ===== MODAL ACCESO ===== */
    #acct-modal.acct-hidden{display:none!important}
    #acct-modal{position:fixed;inset:0;background:rgba(6,10,18,.65);backdrop-filter:blur(8px);display:grid;place-items:center;z-index:1000}
    .acct-dialog{
      width:min(560px,92%); max-height:90vh; overflow:auto;
      background:var(--bg-2); border:1px solid rgba(255,255,255,.10); border-radius:20px; box-shadow:var(--shadow);
      padding:0; color:var(--txt)
    }
    .acct-cover{background:linear-gradient(135deg,var(--brand-1),var(--brand-2));height:6px;width:100%}
    .acct-body{padding:22px}
    .acct-head{display:flex;justify-content:center;align-items:center;margin:10px 0 18px}
    .acct-logo{width:48px;height:48px;border-radius:16px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand-1),var(--brand-2));color:#061017;font-weight:900}
    .acct-title{margin:10px 0 0;text-align:center;font-weight:800;font-size:1.25rem}
    .acct-sub{margin:6px 0 0;text-align:center;color:var(--muted);font-size:.96rem}

    .acct-tabs{display:flex;gap:8px;margin:16px auto 12px;justify-content:center}
    .acct-tabs .acct-tab{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);border-radius:999px;padding:8px 14px;cursor:pointer;color:inherit;font-weight:700}
    .acct-tabs .acct-tab.acct-tab-active{background:linear-gradient(135deg,var(--brand-1),var(--brand-2)); color:#061017}

    .acct-form{display:grid;gap:12px;margin-top:6px}
    .acct-label{font-weight:600}
    .acct-input{position:relative}
    .acct-input input{
      width:100%;background:#0a0f16;border:1px solid rgba(255,255,255,.14);color:inherit;border-radius:12px;padding:12px 42px 12px 12px;font-size:16px;
      transition:border .2s, box-shadow .2s
    }
    .acct-input input:focus{outline:none;border-color:rgba(0,212,255,.45); box-shadow:0 0 0 3px rgba(0,212,255,.25),0 0 0 6px rgba(124,58,237,.18)}
    .toggle-eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:#cfe3ff;cursor:pointer}
    .acct-err{color:#ef4444;margin-top:2px}
    .acct-ok{color:#22c55e;margin-top:2px}
    .acct-row{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .acct-actions{display:grid;gap:10px}
    .btn-google{background:#db4437;color:#fff}
    .btn-google:hover{filter:brightness(.95)}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <a class="brand" href="index.html" aria-label="Inicio">
        <span class="brand-logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none"><path d="M5 12a7 7 0 1114 0v6.5a2.5 2.5 0 01-5 0V9.75a2.25 2.25 0 10-4.5 0V18.5a2.5 2.5 0 01-5 0V12z" stroke="#061017" stroke-width="1.7"/></svg>
        </span>
        <span>taply</span>
      </a>

      <nav class="nav-links">
        <a class="ghost" href="#beneficios">Beneficios</a>
        <a class="ghost" href="#como-funciona">Cómo funciona</a>
        <a class="ghost" href="#reviews">Opiniones</a>
        <a class="ghost" href="suscripciones.html">Suscripciones</a>
        <a class="btn" href="suscripciones.html">¡Comenzar ahora!</a>
        <span id="acct-nav-slot" class="acct-dd"></span>
      </nav>

      <button class="menu ghost" id="menuBtn" aria-expanded="false" aria-controls="mobileMenu">Menú</button>
    </div>

    <div class="container mobile-menu" id="mobileMenu" role="menu" aria-label="Menú móvil">
      <div class="mobile-links">
        <a class="ghost" href="#beneficios" role="menuitem">Beneficios</a>
        <a class="ghost" href="#como-funciona" role="menuitem">Cómo funciona</a>
        <a class="ghost" href="#reviews" role="menuitem">Opiniones</a>
        <a class="ghost" href="suscripciones.html" role="menuitem">Suscripciones</a>
        <a class="btn" href="suscripciones.html" role="menuitem">¡Comenzar ahora!</a>
        <span id="acct-nav-slot-mobile" class="acct-dd" style="margin-top:8px"></span>
      </div>
    </div>
  </header>

  <main>
    <section class="hero" aria-labelledby="hero-title">
      <div class="container hero-grid">
        <div>
          <h1 id="hero-title">¿Imaginas subir la valoración de tu negocio <em>SIN HACER NADA</em>?</h1>
          <p class="lead">Aumenta tus reseñas, protege tu reputación y convierte opiniones en más clientes y más ingresos, sin mover un solo dedo.</p>
          <div class="pills"><div class="pill">Mejores reseñas</div><div class="pill">Más clientes</div><div class="pill">Más dinero</div></div>
          <div class="cta-row">
            <a class="btn" href="suscripciones.html">Ver suscripciones</a>
          </div>
        </div>
      </div>
    </section>

    <section id="beneficios">
      <div class="container">
        <h2>¿Qué podrás conseguir gracias a nuestro sistema?</h2>
        <p class="lead">Taply te asegura conseguir <strong>mejores reseñas</strong>, atraer <strong>más clientes</strong> y generar <strong>más ingresos</strong>.</p>
        <div class="grid-3" style="margin-top:20px">
          <article class="card"><h3>Crea un clima donde la opinión importa</h3><p>El cliente acerca su móvil al NFC y deja su reseña en segundos.</p></article>
          <article class="card"><h3>Encuentra puntos débiles</h3><p>Las negativas no se publican: van a tu panel privado para aprender y mejorar.</p></article>
          <article class="card"><h3>Gana dinero</h3><p>Mejores valoraciones = más visibilidad = más clientes.</p></article>
        </div>
        <div class="cta-row"><a class="btn" href="suscripciones.html">Empezar ahora</a></div>
      </div>
    </section>

    <!-- RESEÑAS -->
    <section class="reviews" id="reviews" aria-labelledby="reviews-title">
      <div class="container">
        <h2 id="reviews-title">Valorado 4,8/5 por más de 30 negocios</h2>

        <div class="reviews-window">
          <button class="carousel-btn left" id="revPrev" aria-label="Opinión anterior"><span>‹</span></button>
          <button class="carousel-btn right" id="revNext" aria-label="Opinión siguiente"><span>›</span></button>

          <div class="reviews-track" id="reviewsTrack" tabindex="0" aria-label="Opiniones de clientes">
            <article class="review-card"><div class="review-header"><div class="review-avatar"><img loading="lazy" src="https://i.pravatar.cc/110?img=26" alt="Sara Cordero" width="54" height="54"></div><div><div class="review-name">Sara Cordero</div><div class="review-stars" aria-label="5 de 5">★★★★★</div></div></div><p class="review-text">Instalación en 5 minutos. Los avisos de reseñas negativas nos han permitido corregir fallos en días.</p></article>
            <article class="review-card"><div class="review-header"><div class="review-avatar"><img loading="lazy" src="https://i.pravatar.cc/110?img=33" alt="Marlon Melara" width="54" height="54"></div><div><div class="review-name">Marlon Melara</div><div class="review-stars" aria-label="5 de 5">★★★★★</div></div></div><p class="review-text">Ahorra tiempo en reputación online. Muy fácil para el cliente.</p></article>
            <article class="review-card"><div class="review-header"><div class="review-avatar"><img loading="lazy" src="https://i.pravatar.cc/110?img=12" alt="Joan Blanch" width="54" height="54"></div><div><div class="review-name">Joan Blanch</div><div class="review-stars" aria-label="5 de 5">★★★★★</div></div></div><p class="review-text">Subimos reseñas sin pedirlo. El panel de negativas nos ha ayudado a mejorar procesos.</p></article>
            <article class="review-card"><div class="review-header"><div class="review-avatar"><img loading="lazy" src="https://i.pravatar.cc/110?img=5" alt="Eco Abraham" width="54" height="54"></div><div><div class="review-name">Eco Abraham</div><div class="review-stars" aria-label="5 de 5">★★★★★</div></div></div><p class="review-text">Nunca había conseguido tantas reseñas reales tan rápido. El flujo NFC es comodísimo.</p></article>
          </div>
        </div>
      </div>
    </section>

    <section id="como-funciona">
      <div class="container"><h2>¿Cómo funciona Taply?</h2></div>
      <div class="container grid-3">
        <div class="card"><h3>1) Acerca el móvil</h3><p>Coloca los dispositivos <strong>Taply</strong> en tus mesas. Al acercar el smartphone aparece la pantalla de valoración.</p></div>
        <div class="card"><h3>2) Enrutado inteligente</h3><p>Si la experiencia es positiva, va a Google a dejar reseña. Si es negativa, se abre un formulario privado.</p></div>
        <div class="card"><h3>3) Formulario privado</h3><p>Adaptado a tu negocio (tiempos, atención, calidad…). Lo conectamos a una hoja privada donde se guardan todas las respuestas.</p></div>
        <div class="card"><h3>4) Aprende y mejora</h3><p>Consulta la hoja cuando quieras: gráficos, filtros por fecha y patrones para mejorar sin afectar tu puntuación pública.</p></div>
        <div class="card"><h3>5) Todo suma</h3><p>Mejores valoraciones elevan tu visibilidad en el buscador, aumentan la confianza y traen más clientes.</p></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container" style="padding:40px 0;color:#b7c3d2;border-top:1px solid rgba(255,255,255,.06)">
      <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:20px">
        <div>
          <div class="brand" style="margin-bottom:10px"><span class="brand-logo" aria-hidden="true"></span><span>taply</span></div>
          <p style="color:#9fb0c8;max-width:560px">Tecnología NFC para convertir feedback en crecimiento real.</p>
        </div>
        <div>
          <p><a href="#beneficios">Beneficios</a></p>
          <p><a href="suscripciones.html">Suscripciones</a></p>
        </div>
        <div>
          <p><a href="#como-funciona">Cómo funciona</a></p>
          <p><a href="suscripciones.html">Comenzar ahora</a></p>
        </div>
      </div>
    </div>
  </footer>

  <!-- ===== MODAL ACCESO ===== -->
  <div id="acct-modal" class="acct-hidden" role="dialog" aria-modal="true" aria-labelledby="acct-title">
    <div class="acct-dialog">
      <div class="acct-cover"></div>
      <div class="acct-body">
        <div class="acct-head"><div class="acct-logo">⌁</div></div>
        <h3 id="acct-title" class="acct-title">Inicia sesión en tu cuenta</h3>
        <p id="acct-sub" class="acct-sub">Introduce tus datos de acceso o crea una cuenta nueva.</p>

        <div class="acct-tabs" role="tablist">
          <button class="acct-tab acct-tab-active" data-tab="login" role="tab" aria-selected="true">Iniciar sesión</button>
          <button class="acct-tab" data-tab="register" role="tab" aria-selected="false">Registrarse</button>
        </div>

        <!-- LOGIN -->
        <form id="acct-form-login" class="acct-form" autocomplete="on" novalidate>
          <label class="acct-label">Correo
            <span class="acct-input">
              <input id="acct-login-email" type="email" required autocomplete="email" inputmode="email" placeholder="tucorreo@ejemplo.com">
            </span>
          </label>
          <label class="acct-label">Contraseña
            <span class="acct-input">
              <input id="acct-login-pass" type="password" required autocomplete="current-password" placeholder="••••••••">
              <button type="button" class="toggle-eye" data-toggle="#acct-login-pass" aria-label="Mostrar u ocultar contraseña">👁</button>
            </span>
          </label>

          <div class="acct-row">
            <label class="remember"><input type="checkbox" checked> Mantener sesión activa</label>
            <button type="button" id="link-forgot" class="acct-tab" style="background:transparent;border:1px dashed rgba(255,255,255,.18);cursor:pointer">¿Olvidaste la contraseña?</button>
          </div>

          <div class="acct-actions">
            <button type="submit" class="btn">Iniciar sesión</button>
            <a id="btn-google-login" href="/api/google?from=login" class="btn btn-google" rel="nofollow">Continuar con Google</a>
            <p id="acct-error-login" class="acct-err" style="display:none"></p>
          </div>
        </form>

        <!-- REGISTER -->
        <form id="acct-form-register" class="acct-form" style="display:none" autocomplete="on" novalidate>
          <label class="acct-label">Nombre
            <span class="acct-input"><input id="acct-reg-name" type="text" required autocomplete="name" placeholder="Nombre y apellidos"></span>
          </label>
          <label class="acct-label">Correo
            <span class="acct-input"><input id="acct-reg-email" type="email" required autocomplete="email" inputmode="email" placeholder="tucorreo@ejemplo.com"></span>
          </label>
          <label class="acct-label">Contraseña
            <span class="acct-input">
              <input id="acct-reg-pass" type="password" required minlength="6" autocomplete="new-password" placeholder="Mínimo 6 caracteres">
              <button type="button" class="toggle-eye" data-toggle="#acct-reg-pass">👁</button>
            </span>
          </label>
          <label class="acct-label">Confirmar contraseña
            <span class="acct-input">
              <input id="acct-reg-pass2" type="password" required minlength="6" autocomplete="new-password" placeholder="Repite la contraseña">
              <button type="button" class="toggle-eye" data-toggle="#acct-reg-pass2">👁</button>
            </span>
          </label>
          <div class="meter" aria-hidden="true"><i id="pw-meter" style="display:block;height:6px;border-radius:6px;background:#1f2937;width:0"></i></div>
          <div class="acct-actions">
            <button type="submit" class="btn">Crear cuenta</button>
            <a id="btn-google-register" href="/api/google?from=register" class="btn btn-google" rel="nofollow">Registrarme con Google</a>
            <p id="acct-error-register" class="acct-err" style="display:none"></p>
          </div>
        </form>

        <!-- RECOVER -->
        <form id="acct-form-recover" class="acct-form" style="display:none" autocomplete="on" novalidate>
          <p class="acct-small">Te enviaremos un enlace para restablecer tu contraseña.</p>
          <label class="acct-label">Correo
            <span class="acct-input"><input id="acct-recover-email" type="email" autocomplete="email" inputmode="email" placeholder="tucorreo@ejemplo.com"></span>
          </label>
          <div class="acct-actions">
            <button type="submit" class="btn">Enviar enlace</button>
            <button type="button" class="btn ghost" id="recover-back">Volver</button>
            <p id="acct-info-recover" class="acct-ok" style="display:none"></p>
            <p id="acct-error-recover" class="acct-err" style="display:none"></p>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('load', () => document.body.classList.add('is-loaded'));

    // Menú móvil
    const menuBtn=document.getElementById('menuBtn');
    const mobileMenu=document.getElementById('mobileMenu');
    menuBtn?.addEventListener('click', ()=> {
      const open = mobileMenu.style.display === 'block';
      mobileMenu.style.display = open ? 'none' : 'block';
      menuBtn.setAttribute('aria-expanded', String(!open));
    });
    mobileMenu?.addEventListener('click', (e)=>{ const a = e.target.closest('a'); if(a){ mobileMenu.style.display='none'; menuBtn.setAttribute('aria-expanded','false'); } });
    window.addEventListener('resize', ()=>{ if(window.innerWidth > 768){ mobileMenu.style.display='none'; menuBtn.setAttribute('aria-expanded','false'); } });

    // Carrusel de reseñas
    (function(){
      const track = document.getElementById('reviewsTrack');
      const prev = document.getElementById('revPrev');
      const next = document.getElementById('revNext');
      const cards = () => Array.from(track.querySelectorAll('.review-card'));
      const centerX = () => track.scrollLeft + track.clientWidth/2;
      function nearestIndex(){ const cx=centerX(); let best=0,dist=1/0; cards().forEach((el,i)=>{ const mid=el.offsetLeft+el.clientWidth/2; const d=Math.abs(mid-cx); if(d<dist){dist=d;best=i;} }); return best; }
      function scrollToIndex(i){ const arr=cards(); i=Math.max(0,Math.min(arr.length-1,i)); const el=arr[i]; const x=el.offsetLeft-(track.clientWidth-el.clientWidth)/2; track.scrollTo({left:x,behavior:'smooth'}); }
      function step(d){ scrollToIndex(nearestIndex()+d); }
      prev?.addEventListener('click',()=>step(-1)); next?.addEventListener('click',()=>step(1));
      track?.addEventListener('keydown',(e)=>{ if(e.key==='ArrowLeft')step(-1); else if(e.key==='ArrowRight')step(1); });
      let t; track.addEventListener('scroll',()=>{ clearTimeout(t); t=setTimeout(()=>scrollToIndex(nearestIndex()),120); }, {passive:true});
    })();

    /* ======= Cuenta ======= */
    (function(){
      const S = { user:null, polling:null };
      const $  = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const modal = $('#acct-modal');

      const forms = {
        login:   $('#acct-form-login'),
        register:$('#acct-form-register'),
        recover: $('#acct-form-recover')
      };
      const errs  = {
        login:   $('#acct-error-login'),
        register:$('#acct-error-register'),
        recover: $('#acct-error-recover')
      };
      const okRecover = $('#acct-info-recover');

      // ---- Navegación / historial para cerrar con "Atrás"
      const AUTH_HASHES = ['#auth-login','#auth-register','#auth-recover'];
      function pushAuthState(tab){
        const h = '#auth-' + tab;
        history.pushState({auth:true, tab}, '', h);
      }
      window.addEventListener('popstate', (e)=>{
        if(e.state && e.state.auth){
          // cambiaron entre tabs con atrás/adelante
          setTab(e.state.tab);
          if(modal.classList.contains('acct-hidden')) modal.classList.remove('acct-hidden');
        }else{
          // salimos del modal
          closeModal(true);
        }
      });
      function cleanAuthHash(){
        if (AUTH_HASHES.includes(location.hash)) {
          history.replaceState(null,'',location.pathname + location.search);
        }
      }

      function setTab(name, fromHistory=false){
        forms.login.style.display    = name==='login'    ? 'grid' : 'none';
        forms.register.style.display = name==='register' ? 'grid' : 'none';
        forms.recover.style.display  = name==='recover'  ? 'grid' : 'none';
        document.querySelectorAll('#acct-modal .acct-tabs .acct-tab').forEach(b=>{
          const on=b.dataset.tab===name; b.classList.toggle('acct-tab-active', on);
          b.setAttribute('aria-selected', String(on));
        });
        if(name==='login'){ $('#acct-title').textContent='Inicia sesión en tu cuenta'; $('#acct-sub').textContent='Introduce tus datos de acceso o crea una cuenta nueva.'; }
        if(name==='register'){ $('#acct-title').textContent='Crea tu cuenta ahora mismo'; $('#acct-sub').textContent='Completa tus datos para registrarte en Taply.'; }
        if(name==='recover'){ $('#acct-title').textContent='Recuperar contraseña'; $('#acct-sub').textContent='Te enviaremos un enlace a tu correo para restablecerla.'; }
        if(!fromHistory) pushAuthState(name);
      }
      function openModal(tab='login'){ modal.classList.remove('acct-hidden'); setTab(tab); setTimeout(()=>$('#acct-login-email')?.focus(),40); }
      function closeModal(fromHistory=false){
        modal.classList.add('acct-hidden');
        Object.values(errs).forEach(e=>e&&(e.style.display='none')); okRecover.style.display='none';
        if(!fromHistory) cleanAuthHash(); // si cerramos nosotros, limpiamos hash
      }
      document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });
      modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });

      document.querySelectorAll('#acct-modal .acct-tabs .acct-tab').forEach(b=> b.addEventListener('click', ()=> setTab(b.dataset.tab)));
      $('#link-forgot')?.addEventListener('click', ()=> setTab('recover'));
      $('#recover-back')?.addEventListener('click', ()=> setTab('login'));

      $$('.toggle-eye').forEach(btn=>btn.addEventListener('click', ()=>{ const sel=btn.getAttribute('data-toggle'); const input=document.querySelector(sel); if(!input) return; input.type = input.type==='password' ? 'text' : 'password'; }));

      // Métrica de contraseña (registro)
      const meter = document.getElementById('pw-meter');
      document.getElementById('acct-reg-pass')?.addEventListener('input', e=>{
        const v=e.target.value||''; let score=0;
        if(v.length>=6) score+=33; if(/[A-Z]/.test(v)&&/[a-z]/.test(v)) score+=33; if(/\d/.test(v)||/[^A-Za-z0-9]/.test(v)) score+=34;
        if(meter){ meter.style.width=Math.min(100,score)+'%'; meter.style.background=score>80?'#22c55e':score>50?'#f59e0b':'#ef4444'; }
      });

      async function api(method,url,body){
        const res=await fetch(url,{method,headers:{'Content-Type':'application/json'},credentials:'include',cache:'no-store',body:body?JSON.stringify(body):undefined});
        let data=null; try{ data=await res.json(); }catch{}
        if(!res.ok) throw (data?.error || `HTTP ${res.status}`); return data;
      }

      function setUser(u){
        S.user = u || null;
        try{ localStorage.setItem('acct_user', u ? JSON.stringify(u) : ""); }catch{}
        window.taplyAuth = window.taplyAuth || {}; window.taplyAuth.user = S.user;
        paintNav();
      }

      // Recover
      forms.recover?.addEventListener('submit', async e=>{
        e.preventDefault(); errs.recover.style.display='none'; okRecover.style.display='none';
        const email=$('#acct-recover-email').value.trim();
        try{ await api('POST','/api/request-password-reset',{email}); okRecover.textContent='Si el correo está registrado, te hemos enviado un enlace (caduca en 1 hora).'; okRecover.style.display='block'; }
        catch(err){ errs.recover.textContent=String(err); errs.recover.style.display='block'; }
      });

      // Login
      forms.login?.addEventListener('submit', async e=>{
        e.preventDefault(); errs.login.style.display='none';
        const email=$('#acct-login-email').value.trim(); const password=$('#acct-login-pass').value;
        try{ const data=await api('POST','/api/login',{email,password}); setUser(data?.user||null); await forceSessionRefresh(); closeModal(); }
        catch(err){
          errs.login.textContent=(err==='account_not_found')?'No existe una cuenta con ese email.':
                                 (err==='invalid_credentials')?'Contraseña incorrecta.':
                                 (err==='password_not_set')?'Esta cuenta no tiene contraseña. Usa “¿Olvidaste la contraseña?”':String(err);
          errs.login.style.display='block';
        }
      });

      // Registro
      forms.register?.addEventListener('submit', async e=>{
        e.preventDefault(); errs.register.style.display='none';
        const name=$('#acct-reg-name').value.trim(); const email=$('#acct-reg-email').value.trim();
        const p1=$('#acct-reg-pass').value; const p2=$('#acct-reg-pass2').value;
        if(p1!==p2){ errs.register.textContent='Las contraseñas no coinciden.'; return void(errs.register.style.display='block'); }
        if(p1.length<6){ errs.register.textContent='La contraseña debe tener al menos 6 caracteres.'; return void(errs.register.style.display='block'); }
        if(!name){ errs.register.textContent='El nombre es obligatorio.'; return void(errs.register.style.display='block'); }
        try{ const data=await api('POST','/api/register',{name,email,password:p1}); setUser(data?.user||null); await forceSessionRefresh(); closeModal(); }
        catch(err){
          errs.register.textContent=(err==='email_in_use_google')?'Ese correo ya existe como cuenta Google. Inicia sesión con Google.':
                                   (err==='email_in_use')?'Ese correo ya tiene una cuenta. Inicia sesión.':
                                   (err==='weak_password')?'La contraseña debe tener al menos 6 caracteres.':
                                   (err==='name_email_password_required')?'Nombre, email y contraseña son obligatorios.':String(err);
          errs.register.style.display='block';
        }
      });

      // ---- Google: dejar que el <a> navegue nativo (evita bloqueos "usar otra cuenta")
      function bindGoogle(id, from){
        const el=document.getElementById(id); if(!el) return;
        el.removeAttribute('target'); // misma pestaña
        el.addEventListener('click', ()=>{ try{ sessionStorage.setItem('taply_from', from); }catch{} }, {capture:true});
        // NO preventDefault; dejamos que siga el href
      }
      bindGoogle('btn-google-login','login');
      bindGoogle('btn-google-register','register');

      // Menú / sesión
      function paintNav(){
        const slots = ['#acct-nav-slot','#acct-nav-slot-mobile'].map(s=>document.querySelector(s)).filter(Boolean);
        slots.forEach(slot=>{
          if(!S.user){
            slot.classList.remove('open');
            slot.innerHTML = `<button id="acct-open-nav" class="btn" style="--p:10px 14px">Iniciar sesión</button>`;
            slot.querySelector('#acct-open-nav')?.addEventListener('click', ()=> openModal('login'));
            return;
          }
          const name=(S.user?.name||S.user?.email||'Mi cuenta').split(' ')[0];
          const initials=(name?.[0]||'T').toUpperCase();
          slot.innerHTML = `
            <div class="acct-chip" id="acct-chip" role="button" aria-haspopup="true" aria-expanded="false">
              <span class="acct-avatar">${initials}</span>
              <strong>${name}</strong>
            </div>
            <div class="acct-menu" role="menu">
              <button id="acct-logout-btn" role="menuitem">Cerrar sesión</button>
            </div>`;
          const dd=slot, chip=dd.querySelector('#acct-chip');
          chip?.addEventListener('click', ()=>{ dd.classList.toggle('open'); chip.setAttribute('aria-expanded', dd.classList.contains('open')?'true':'false'); });
          document.addEventListener('click', (e)=>{ if(!dd.contains(e.target)) dd.classList.remove('open'); });
          dd.querySelector('#acct-logout-btn')?.addEventListener('click', async ()=>{ try{ await api('POST','/api/logout',{});}catch{} setUser(null); alert('Sesión cerrada'); });
        });
      }

      async function forceSessionRefresh(retries=4, delay=600){
        for(let i=0;i<retries;i++){ try{ const data=await api('GET','/api/session'); if(data?.user){ setUser(data.user); break; } }catch{} await new Promise(r=>setTimeout(r,delay)); }
      }

      // Mapeo errores Google + manejo del hash y sessionStorage 'from'
      function mapGoogleError(code){
        switch(String(code||'').toLowerCase()){
          case 'email_in_use_password': return 'Ese correo ya tiene una cuenta con contraseña. Inicia sesión con tu contraseña.';
          case 'email_in_use_google':   return 'Ese correo ya está registrado con Google. Inicia sesión con Google.';
          case 'email_in_use':          return 'Ese correo ya está en uso.';
          case 'use_password_login':    return 'Esa cuenta no está vinculada a Google. Usa correo y contraseña.';
          case 'not_registered':        return 'No existe ninguna cuenta registrada con ese Google. Regístrate primero.';
          case 'email_not_verified':    return 'Tu correo de Google no está verificado.';
          case 'state_error':           return 'Error de seguridad (state). Inténtalo de nuevo.';
          case 'google_auth_failed':    return 'No se pudo completar con Google. Inténtalo otra vez.';
          case 'server_error':          return 'Error del servidor. Intenta de nuevo.';
          default:                      return 'No se pudo completar con Google. Inténtalo otra vez.';
        }
      }
      async function handleGoogleHash(){
        const raw = (location.hash || '').replace(/^#/, '');
        if(!raw) return;
        const params = new URLSearchParams(raw.replace(/;/g,'&'));
        const g = params.get('google');      // ok | err
        let from = (params.get('from') || sessionStorage.getItem('taply_from') || 'login').toLowerCase();
        const code = params.get('code');
        try{ sessionStorage.removeItem('taply_from'); }catch{}
        if (g === 'ok') {
          await forceSessionRefresh();
          history.replaceState(null,'',location.pathname + location.search);
          return;
        }
        if (g === 'err') {
          openModal(from === 'register' ? 'register' : 'login');
          const target = (from === 'register') ? errs.register : errs.login;
          if (target){ target.textContent = mapGoogleError(code); target.style.display = 'block'; }
          history.replaceState(null,'',location.pathname + location.search);
        }
      }

      async function getSession(){
        try{ const v=localStorage.getItem('acct_user')||''; setUser(v?JSON.parse(v):null); }catch{ setUser(null); }
        try{ const data=await api('GET','/api/session'); setUser(data?.user||null); }catch{}
        await handleGoogleHash();
      }

      getSession();
      window.TaplyOpenLogin = openModal;

      // Si recargan con hash #auth-* (por compartir URL), abrir el modal correspondiente
      if(['#auth-login','#auth-register','#auth-recover'].includes(location.hash)){
        openModal(location.hash.replace('#auth-',''));
      }
    })();
  </script>
</body>
</html>

