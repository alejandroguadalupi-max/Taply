<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>Taply ‚Äî NFC + Suscripci√≥n</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f1a; --bg-2:#0e1424; --card:#0d1220; --txt:#e9eefc; --muted:#9fb0c6;
      --brand-1:#00d4ff; --brand-2:#7c3aed; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --border:rgba(255,255,255,.10); --radius:18px;
      --shadow:0 12px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
      --focus:0 0 0 3px rgba(0,212,255,.25),0 0 0 6px rgba(124,58,237,.18);
    }
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--txt);opacity:0;transition:.35s}
    body.is-loaded{opacity:1}
    a{text-decoration:none;color:inherit}
    .container{max-width:1100px;width:92%;margin-inline:auto}

    header{padding:14px 0;border-bottom:1px solid var(--border);background:#0a0f16cc;backdrop-filter:blur(10px)}
    .brand{font-weight:800;display:flex;align-items:center;gap:8px;justify-content:space-between}
    .logo-img{width:34px;height:34px;border-radius:10px;object-fit:cover;display:block}

    .banner{display:none}
    .banner.show{display:block}
    .banner .box{
      margin:10px auto 0; width:92%; max-width:1100px;
      background:linear-gradient(135deg, rgba(34,197,94,.15), rgba(0,212,255,.12));
      border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:12px 14px;
      box-shadow:var(--shadow); color:#d9ffe6; font-weight:700; text-align:center
    }
    .banner.err .box{ background:linear-gradient(135deg, rgba(239,68,68,.18), rgba(124,58,237,.12)); color:#ffe0e0 }
    .banner.warn .box{ background:linear-gradient(135deg, rgba(245,158,11,.18), rgba(124,58,237,.10)); color:#fff5d6 }

    .hero{text-align:center;padding:40px 0 24px}
    .h1{font-size:clamp(2rem,5.5vw,3.2rem);margin:0;font-weight:800}
    .lead{color:var(--muted);max-width:860px;margin:12px auto 0}

    .steps{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:18px 0}
    .step-pill{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.04);font-weight:600}
    .n{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand-1),var(--brand-2));color:#061017;font-size:12px}

    .chooser{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin:24px auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;display:flex;flex-direction:column;justify-content:space-between}
    .card h3{margin:0 0 6px;font-size:1.2rem}
    .card p{margin:0;color:var(--muted)}
    .badge{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);color:#cfe3ff;display:inline-block;margin-bottom:8px}
    .actions{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    .btn{
      padding:12px 16px;border:0;border-radius:999px;font-weight:800;cursor:pointer;display:inline-flex;justify-content:center;align-items:center;
      background:linear-gradient(135deg,var(--brand-1),var(--brand-2));color:#061017;box-shadow:0 10px 28px rgba(124,58,237,.35),0 4px 14px rgba(0,212,255,.25);
      touch-action:manipulation; -webkit-tap-highlight-color:transparent; user-select:none; font-size:16px
    }
    .btn:focus-visible{outline:none; box-shadow:var(--focus)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--txt);box-shadow:none}
    .btn.line{background:transparent;border:1px dashed var(--border);color:var(--muted)}
    .btn-google{background:#db4437;color:#fff}
    .btn-google:hover{filter:brightness(.95)}
    .seg{display:flex;justify-content:center;gap:10px;margin:22px auto}
    .seg button{border:0;padding:10px 18px;border-radius:999px;font-weight:700;cursor:pointer;background:rgba(255,255,255,.06);color:var(--muted);font-size:16px}
    .seg button.active{background:linear-gradient(135deg,var(--brand-1),var(--brand-2));color:#061017}

    .plan-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;align-items:stretch}
    .plan{display:flex;flex-direction:column;justify-content:space-between}
    .price-lg{font-size:32px;font-weight:800;margin:8px 0}
    .per{color:var(--muted);font-size:14px;font-weight:600}
    .desc{color:var(--muted);flex:1;margin:8px 0 12px}
    .plan.rec{outline:2px solid rgba(0,212,255,.25);box-shadow:0 0 0 5px rgba(124,58,237,.08),var(--shadow)}

    footer{text-align:center;padding:28px 0 36px;color:#b7c3d2;border-top:1px solid var(--border)}
    @media(max-width:700px){.btn,.btn.ghost{width:100%}}

    .panel{display:none;margin-bottom:40px}
    .panel.show{display:block}

    /* ===== MODAL ACCESO ===== */
    #acct-modal.acct-hidden{display:none!important}
    #acct-modal{position:fixed;inset:0;background:rgba(6,10,18,.65);backdrop-filter:blur(8px);display:grid;place-items:center;z-index:1000}
    .acct-dialog{
      width:min(560px,92%); max-height:90vh; overflow:auto;
      background:var(--bg-2); border:1px solid var(--border); border-radius:20px; box-shadow:var(--shadow);
      padding:0; color:var(--txt)
    }
    .acct-cover{background:linear-gradient(135deg,var(--brand-1),var(--brand-2));height:6px;width:100%}
    .acct-body{padding:22px}
    .acct-head{display:flex;justify-content:center;align-items:center;margin:10px 0 18px}
    .acct-logo{width:48px;height:48px;border-radius:16px;display:block;background:url('img/logo.png') center/cover no-repeat;box-shadow:var(--shadow);color:transparent;font-size:0;line-height:0}
    .acct-title{margin:10px 0 0;text-align:center;font-weight:800;font-size:1.25rem}
    .acct-sub{margin:6px 0 0;text-align:center;color:var(--muted);font-size:.96rem}

    .acct-tabs{display:flex;gap:8px;margin:16px auto 12px;justify-content:center}
    .acct-tab{border:1px solid var(--border);background:rgba(255,255,255,.05);border-radius:999px;padding:8px 14px;cursor:pointer;color:inherit;font-weight:700}
    .acct-tab.acct-tab-active{background:linear-gradient(135deg,var(--brand-1),var(--brand-2)); color:#061017}

    .acct-form{display:grid;gap:12px;margin-top:6px}
    .acct-label{font-weight:600}
    .acct-input{position:relative}
    .acct-input input{
      width:100%;background:#0a0f16;border:1px solid var(--border);color:inherit;border-radius:12px;padding:12px 42px 12px 12px;font-size:16px;
      transition:border .2s, box-shadow .2s
    }
    .acct-input input:focus{outline:none;border-color:rgba(0,212,255,.45); box-shadow:var(--focus)}
    .toggle-eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:#cfe3ff;cursor:pointer}
    .acct-err{color:var(--err);margin-top:2px}
    .acct-ok{color:var(--ok);margin-top:2px}
    .acct-row{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .acct-actions{display:grid;gap:10px}

    .plan-badge{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:999px;background:linear-gradient(135deg,#22c55e,#00d4ff);color:#061017;font-weight:900;letter-spacing:.3px;text-transform:uppercase;box-shadow:0 10px 28px rgba(0,212,255,.25),inset 0 1px 0 rgba(255,255,255,.35)}
    .nfc-chip{display:inline-flex;align-items:center;gap:8px;margin-top:10px;padding:12px 16px;border-radius:14px;background:rgba(124,58,237,.10);border:1px solid rgba(124,58,237,.35);font-weight:800;color:#cfe3ff}
    .acct-small{color:var(--muted);font-size:.92rem;margin-top:6px}
  </style>
</head>
<body>
<header>
  <div class="container brand">
    <div style="display:flex;align-items:center;gap:8px">
      <a href="index.html" aria-label="Inicio" style="display:flex;align-items:center;gap:8px;color:inherit">
        <img src="img/logo.png" alt="Taply" class="logo-img">
        <span>Taply</span>
      </a>
    </div>
    <nav class="nav-links" style="display:flex;gap:12px;align-items:center">
      <span id="acct-nav-slot" style="position:relative"></span>
    </nav>
  </div>
  <div id="top-banner" class="banner"><div class="box" id="top-banner-text"></div></div>
</header>

<section class="hero">
  <div class="container">
    <h1 class="h1">Empieza en dos pasos</h1>
    <p class="lead">Primero compra los NFC para tus mesas, despu√©s activa la suscripci√≥n que m√°s te convenga. Son pagos independientes y tras cada compra recibir√°s un WhatsApp con instrucciones y contacto directo.</p>
    <div class="steps">
      <span class="step-pill"><span class="n">1</span> Comprar NFC</span>
      <span class="step-pill"><span class="n">2</span> Elegir suscripci√≥n</span>
    </div>

    <div class="chooser">
      <article class="card">
        <span class="badge">Paso 1</span>
        <h3>Comprar NFC</h3>
        <p>Dispositivos que colocas en las mesas o mostradores. Pago √∫nico, necesarios para empezar.</p>
        <div class="actions">
          <a href="#" id="showNfc" class="btn">Comprar NFC</a>
        </div>
      </article>
      <article class="card">
        <span class="badge">Paso 2</span>
        <h3>Activar Suscripci√≥n</h3>
        <p>Elige plan mensual o anual para gestionar rese√±as, panel privado y m√°s. Una vez tengas NFC.</p>
        <div class="actions">
          <a href="#" id="showSub" class="btn">Ver planes</a>
        </div>
      </article>
    </div>
  </div>
</section>

<section id="panel-nfc" class="panel container">
  <article class="card">
    <h3>Compra tus NFC</h3>
    <p class="desc">Selecciona cu√°ntos necesitas. Tras pagar recibir√°s WhatsApp autom√°tico con la gu√≠a.</p>
    <div class="actions" style="justify-content:center;gap:16px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px;border-radius:999px">
        <button id="minus" class="btn ghost" style="padding:6px 12px" aria-label="Quitar uno">‚àí</button>
        <span id="qty" aria-live="polite" style="min-width:2ch;text-align:center;display:inline-block">1</span>
        <button id="plus" class="btn ghost" style="padding:6px 12px" aria-label="A√±adir uno">Ôºã</button>
      </div>
      <div class="price">Total: <span id="totalNfc">‚Äî</span></div>
      <a class="btn acct-guard" id="buyNfcBtn">Comprar ahora</a>
    </div>
    <p style="font-size:14px;text-align:center;margin-top:10px">Precio unitario: <strong id="unitPrice">‚Äî</strong></p>
  </article>
</section>

<section id="panel-sub" class="panel container">
  <div class="seg" role="tablist" aria-label="Frecuencia de facturaci√≥n">
    <button id="btn-month" class="active" role="tab" aria-selected="true">Mensual</button>
    <button id="btn-year" role="tab" aria-selected="false">Anual ¬∑ ahorra</button>
  </div>

  <div class="plan-grid">
    <article class="card plan">
      <span class="badge">B√°sico</span>
      <div class="price-lg"><span id="p-basic">29‚Ç¨</span> <span class="per">/mes</span></div>
      <p class="desc">Con este plan tendr√°s todo el entorno de Taply listo con NFC (comprar previamente) configurados para tu restaurante y un panel privado en Google Sheets‚Ä¶</p>
      <div class="actions"><a class="btn plan acct-guard" data-tier="basic">Elegir B√°sico</a></div>
    </article>

    <article class="card plan rec">
      <span class="badge">Pro ¬∑ Recomendado</span>
      <div class="price-lg"><span id="p-pro">55‚Ç¨</span> <span class="per">/mes</span></div>
      <p class="desc">Este plan lo tiene todo: incluye lo del Plan B√°sico y adem√°s la gesti√≥n completa de tus rese√±as‚Ä¶</p>
      <div class="actions"><a class="btn plan acct-guard" data-tier="pro">Elegir Pro</a></div>
    </article>
  </div>

  <div class="container" style="text-align:center;margin-top:16px">
    <!-- Oculto por defecto; se muestra solo si hay suscripci√≥n activa -->
    <button id="portalBtn" class="btn acct-guard" style="display:none">Gestionar mi suscripci√≥n</button>
  </div>
</section>

<section id="cuenta" class="container" style="padding:40px 0">
  <article class="card">
    <h3 style="margin:0 0 10px">Mi suscripci√≥n</h3>
    <div class="acct-row" style="margin:8px 0 2px">
      <div>
        <div id="acct-status" class="plan-badge">Sesi√≥n no iniciada</div>
        <div id="acct-nfc" class="nfc-chip">NFC comprados: 0</div>
      </div>
    </div>
    <div id="acct-portal-row" style="display:none; margin-top:14px; text-align:left">
      <button id="portalBtnAccount" class="btn">Gestionar suscripci√≥n</button>
    </div>
    <p id="acct-auth-cta" class="acct-small" style="margin-top:10px;display:none">
      ¬øNo tienes cuenta?
      <a id="acct-open-from-section" class="badge" style="cursor:pointer">Inicia sesi√≥n o reg√≠strate</a>
    </p>
  </article>
</section>

<footer>
  <div class="container">
    <p>Primero los dispositivos NFC, despu√©s la suscripci√≥n. Tras cada compra recibir√°s WhatsApp con instrucciones.</p>
  </div>
</footer>

<!-- === SCRIPTS === -->
<script>
  /* ===== Helper de retorno desde Stripe Portal =====
     Usa Return URL: https://taply.es/#from=stripe-portal  (o ‚Ä¶/suscripciones.html#from=stripe-portal)
  */
  (function(){
    var hash = (location.hash||'').replace(/^#/,'');
    var search = (location.search||'').replace(/^\?/,'');
    var h = new URLSearchParams(hash);
    var q = new URLSearchParams(search);
    var from = h.get('from') || q.get('from');

    if (from === 'stripe-portal') {
      // Si no estamos en /suscripciones.html, reenv√≠a ah√≠.
      if (!/\/suscripciones\.html$/i.test(location.pathname)) {
        location.replace('/suscripciones.html#from=stripe-portal');
        return;
      }
      // Ya estamos en suscripciones.html ‚Üí abrir panel de planes y limpiar URL.
      document.addEventListener('DOMContentLoaded', function(){
        var sub = document.getElementById('panel-sub');
        var nfc = document.getElementById('panel-nfc');
        if (sub) sub.classList.add('show');
        if (nfc) nfc.classList.remove('show');
        try { sub && sub.scrollIntoView({behavior:'smooth'}); } catch(e){}
        try { history.replaceState(null,'',location.pathname); } catch(e){}
      });
    }
  })();
</script>

<script>
  // ----------- Utilidades UI ----------- 
  const $ = s => document.querySelector(s), $$ = s => document.querySelectorAll(s);
  const fmt = v => new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(v);
  window.addEventListener('load',()=>document.body.classList.add('is-loaded'));

  const PRICE={ nfcUnit:5, monthly:{ basic:29, pro:55 }, annualDiscount:.20 };
  let qty=1, yearly=false;

  $('#showNfc').addEventListener('click',e=>{e.preventDefault();$('#panel-nfc').classList.add('show');$('#panel-sub').classList.remove('show');$('#panel-nfc').scrollIntoView({behavior:'smooth'});});
  $('#showSub').addEventListener('click',e=>{e.preventDefault();$('#panel-sub').classList.add('show');$('#panel-nfc').classList.remove('show');$('#panel-sub').scrollIntoView({behavior:'smooth'});});

  function paintNfc(){ $('#qty').textContent=qty; $('#totalNfc').textContent=fmt(qty*PRICE.nfcUnit)+' (pago √∫nico)'; $('#unitPrice').textContent=fmt(PRICE.nfcUnit)+' por dispositivo'; }
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function changeQty(delta){ qty = clamp(qty + delta, 1, 999); paintNfc(); }
  function attachStepper(btn, delta){
    let t1=null, t2=null, pressed=false;
    const start=()=>{ pressed=true; changeQty(delta); t1=setTimeout(()=>{ t2=setInterval(()=>changeQty(delta), 60); }, 300); };
    const stop =()=>{ pressed=false; clearTimeout(t1); clearInterval(t2); t1=t2=null; };
    btn.addEventListener('pointerdown', e=>{ e.preventDefault(); start(); });
    ['pointerup','pointercancel','pointerleave','blur'].forEach(ev=>btn.addEventListener(ev, stop));
    btn.addEventListener('click', e=>{ if(pressed){ e.preventDefault(); e.stopPropagation(); } }, true);
  }
  attachStepper($('#minus'), -1); attachStepper($('#plus'), +1); paintNfc();

  function planAmount(tier){
    const m=PRICE.monthly[tier];
    return yearly?Math.round(m*12*(1-PRICE.annualDiscount)):m;
  }
  function paintPrices(){
    $('#p-basic').textContent= yearly ? fmt(planAmount('basic')) : PRICE.monthly.basic+'‚Ç¨';
    $('#p-pro').textContent  = yearly ? fmt(planAmount('pro'))   : PRICE.monthly.pro+'‚Ç¨';
    $$('.per').forEach(el=>el.textContent=yearly?'/a√±o':'/mes');
  }
  $('#btn-month').addEventListener('click',()=>{yearly=false;$('#btn-month').classList.add('active');$('#btn-year').classList.remove('active');$('#btn-month').setAttribute('aria-selected','true');$('#btn-year').setAttribute('aria-selected','false');paintPrices()});
  $('#btn-year').addEventListener('click',()=>{yearly=true;$('#btn-year').classList.add('active');$('#btn-month').classList.remove('active');$('#btn-year').setAttribute('aria-selected','true');$('#btn-month').setAttribute('aria-selected','false');paintPrices()});
  paintPrices();

  // ----------- AUTH + session ----------- 
  (function(){
    const S = { user:null, polling:null };
    const modal = $('#acct-modal'), title = $('#acct-title'), sub = $('#acct-sub');
    const forms = { login:$('#acct-form-login'), register:$('#acct-form-register'), recover:$('#acct-form-recover') };
    const errs  = { login:$('#acct-error-login'), register:$('#acct-error-register'), recover:$('#acct-error-recover') };
    const oks   = { login:$('#acct-info-login'), register:$('#acct-info-register'), recover:$('#acct-info-recover') };

    const readUser=()=>{ try{ const v=localStorage.getItem('acct_user')||''; return v?JSON.parse(v):null; }catch(e){ return null; } };
    function setUser(u){
      S.user = u || null;
      try { localStorage.setItem('acct_user', u ? JSON.stringify(u) : ""); } catch(e){}
      window.taplyAuth = window.taplyAuth || {}; window.taplyAuth.user = S.user;
    }

    function getInterval(u){ return (u?.subscription?.price?.interval || u?.subscription?.plan?.interval || u?.subscription_interval || 'month').toLowerCase(); }
    function prettyPlan(u){
      const nick = (u?.subscription?.price?.nickname || u?.subscription?.plan?.nickname || '').trim();
      if(nick) return nick;
      const interval=(getInterval(u)==='year')?'Anual':'Mensual';
      const idOrNick=((u?.subscription?.price?.id||'')+' '+(u?.subscription?.plan?.nickname||'')).toLowerCase();
      let base='B√°sico';
      if(/pro/.test(idOrNick)) base='Pro';
      return `${base} ${interval}`;
    }
    function isSubActive(u){
      const s=(u?.subscription?.status || u?.subscription_status || '').toLowerCase();
      return s==='active'||s==='trialing'||s==='past_due'||u?.isSubscribed===true;
    }

    function setTab(name){
      forms.login.style.display   = name==='login'   ? 'grid' : 'none';
      forms.register.style.display= name==='register'? 'grid' : 'none';
      forms.recover.style.display = name==='recover' ? 'grid' : 'none';
      document.querySelectorAll('#acct-modal .acct-tab').forEach(b=>{
        const on=b.dataset.tab===name; b.classList.toggle('acct-tab-active',on); b.setAttribute('aria-selected',String(on));
      });
      if(name==='login'){ title.textContent='Inicia sesi√≥n en tu cuenta'; sub.textContent='Introduce tus datos de acceso o crea una cuenta nueva.'; }
      if(name==='register'){ title.textContent='Crea tu cuenta ahora mismo'; sub.textContent='Completa tus datos para registrarte en Taply.'; }
      if(name==='recover'){ title.textContent='Recuperar contrase√±a'; sub.textContent='Te enviaremos un enlace a tu correo para restablecerla.'; }
      Object.values(errs).forEach(x=>x&&(x.style.display='none'));
      Object.values(oks).forEach(x=>x&&(x.style.display='none'));
    }
    function openModal(tab='login'){ $('#acct-modal').classList.remove('acct-hidden'); setTab(tab); setTimeout(()=>$('#acct-login-email')?.focus(),40); }
    function closeModal(){ $('#acct-modal').classList.add('acct-hidden'); Object.values(errs).forEach(e=>e&&(e.style.display='none')); Object.values(oks).forEach(e=>e&&(e.style.display='none')); }
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });
    $('#acct-modal').addEventListener('click', e=>{ if(e.target===$('#acct-modal')) closeModal(); });
    $('#acct-open-from-section')?.addEventListener('click', ()=> openModal('login'));
    document.querySelectorAll('#acct-modal .acct-tab').forEach(b=> b.addEventListener('click', ()=> setTab(b.dataset.tab)));
    $('#link-forgot')?.addEventListener('click', ()=> setTab('recover'));
    $('#recover-back')?.addEventListener('click', ()=> setTab('login'));
    $$('.toggle-eye').forEach(btn=>btn.addEventListener('click', ()=>{ const sel=btn.getAttribute('data-toggle'); const input=document.querySelector(sel); if(!input) return; input.type = input.type==='password' ? 'text' : 'password'; }));

    const meter = document.getElementById('pw-meter');
    document.getElementById('acct-reg-pass')?.addEventListener('input', e=>{
      const v=e.target.value||''; let score=0;
      if(v.length>=6) score+=33; if(/[A-Z]/.test(v)&&/[a-z]/.test(v)) score+=33; if(/\d/.test(v)||/[^A-Za-z0-9]/.test(v)) score+=34;
      if(meter){ meter.style.width=Math.min(100,score)+'%'; meter.style.background=score>80?'#22c55e':score>50?'#f59e0b':'#ef4444'; }
    });

    async function api(method,url,body){
      const res=await fetch(url,{method,headers:{'Content-Type':'application/json'},credentials:'include',cache:'no-store',body:body?JSON.stringify(body):undefined});
      let data=null; try{ data=await res.json(); }catch{}
      if(!res.ok){ const e=new Error(data?.message||`HTTP ${res.status}`); e.code=data?.error||'http_error'; e.fieldErrors=data?.fieldErrors||null; throw e; }
      return data;
    }

    forms.recover?.addEventListener('submit', async e=>{
      e.preventDefault(); errs.recover.style.display='none'; oks.recover.style.display='none';
      const email=$('#acct-recover-email').value.trim();
      try{
        const d=await api('POST','/api/request-password-reset',{email});
        oks.recover.textContent = d?.message || 'Te hemos enviado un enlace (caduca en 1 hora).';
        oks.recover.style.display='block';
      }catch(err){
        if(err.code==='account_not_found'){ errs.recover.textContent='No existe ninguna cuenta con ese correo.'; }
        else { errs.recover.textContent=err.message||'No se pudo enviar el enlace.'; }
        errs.recover.style.display='block';
      }
    });

    async function resendVerification(email){
      if(!email) return;
      try{
        await api('POST','/api/resend-verification',{email});
        oks.login.textContent='Te hemos reenviado el correo de verificaci√≥n.'; oks.login.style.display='block';
        oks.register.textContent='Te hemos reenviado el correo de verificaci√≥n.'; oks.register.style.display='block';
      }catch(e){}
    }

    forms.login?.addEventListener('submit', async e=>{
      e.preventDefault(); errs.login.style.display='none'; oks.login.style.display='none';
      const email=$('#acct-login-email').value.trim(); const password=$('#acct-login-pass').value;
      try{
        const data=await api('POST','/api/login',{email,password});
        setUser(data?.user||null); await forceSessionRefresh(); closeModal();
      }catch(err){
        if(err.code==='email_not_verified'){
          errs.login.innerHTML = 'Tu correo no est√° verificado. <a id="resend-link" style="text-decoration:underline;cursor:pointer">Reenviar verificaci√≥n</a>';
          errs.login.style.display='block';
          setTimeout(()=>{ document.getElementById('resend-link')?.addEventListener('click',()=>resendVerification(email)); },0);
          return;
        }
        const map = {
          account_not_found:'No existe una cuenta con ese email.',
          invalid_credentials:'Correo o contrase√±a incorrectos.',
          password_not_set:'Esta cuenta no tiene contrase√±a. Usa el enlace de recuperaci√≥n.',
          use_google_login:'Este correo est√° registrado con Google. Inicia sesi√≥n con Google.'
        };
        errs.login.textContent = map[err.code] || err.message || 'No se pudo iniciar sesi√≥n.';
        errs.login.style.display='block';
      }
    });

    forms.register?.addEventListener('submit', async e=>{
      e.preventDefault(); errs.register.style.display='none'; oks.register.style.display='none';
      const name=$('#acct-reg-name').value.trim(); const email=$('#acct-reg-email').value.trim();
      const p1=$('#acct-reg-pass').value; const p2=$('#acct-reg-pass2').value;
      if(p1!==p2){ errs.register.textContent='Las contrase√±as no coinciden.'; errs.register.style.display='block'; return; }
      if(p1.length<6){ errs.register.textContent='La contrase√±a debe tener al menos 6 caracteres.'; errs.register.style.display='block'; return; }
      if(!name){ errs.register.textContent='El nombre es obligatorio.'; errs.register.style.display='block'; return; }
      try{
        await api('POST','/api/register',{name,email,password:p1});
        oks.register.innerHTML = `
          Te hemos enviado un correo de verificaci√≥n a <strong>${email}</strong>. Abre ese correo y pulsa ‚ÄúConfirmar‚Äù.
          <br><br>
          <a href="https://mail.google.com/" target="_blank" rel="noopener" class="badge">Abrir Gmail</a>
          <a href="https://outlook.live.com/mail/0/inbox" target="_blank" rel="noopener" class="badge">Abrir Outlook</a>
          <a id="resend-verif" class="badge" style="cursor:pointer">Reenviar verificaci√≥n</a>
        `;
        oks.register.style.display='block';
      }catch(err){
        const map = {
          email_in_use_google:'Ese correo ya existe como cuenta Google. Inicia sesi√≥n con Google.',
          email_in_use:'Ese correo ya tiene una cuenta. Inicia sesi√≥n.',
          weak_password:'La contrase√±a debe tener al menos 6 caracteres.',
          name_email_password_required:'Nombre, email y contrase√±a son obligatorios.'
        };
        errs.register.textContent = map[err.code] || err.message || 'No se pudo crear la cuenta.';
        errs.register.style.display='block';
      }
    });

    function startGooglePolling(){
      if(S.polling) clearInterval(S.polling);
      let tries=0;
      S.polling=setInterval(async ()=>{
        tries++;
        try{
          const data=await api('GET','/api/session');
          if(data?.user){
            setUser(data.user);
            paintNav(); paintAccountSection();
            closeModal();
            clearInterval(S.polling); S.polling=null;
          }
        }catch{}
        if(tries>30){ clearInterval(S.polling); S.polling=null; }
      },2000);
    }
    function bindGoogle(id, from){
      const el=document.getElementById(id);
      if(!el) return;
      el.removeAttribute('target');
      const handler=(e)=>{
        e.preventDefault(); e.stopImmediatePropagation();
        try{ startGooglePolling(); }catch{}
        location.href = `/api/google?from=${encodeURIComponent(from)}`;
        return false;
      };
      el.addEventListener('click', handler, true);
      el.addEventListener('mousedown', (e)=>{ e.preventDefault(); }, true);
    }
    bindGoogle('btn-google-login','login');
    bindGoogle('btn-google-register','register');

    function paintNav(){
      const slot=document.querySelector('#acct-nav-slot');
      const htmlAnon = `<a class="btn ghost" id="acct-open-nav">Iniciar sesi√≥n</a>`;
      const name=(S.user?.name||S.user?.email||'').split(' ')[0]||'Mi cuenta';
      const htmlLogged=`
        <span class="btn ghost" id="acct-user-menu" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
          <span style="width:28px;height:28px;border-radius:999px;background:linear-gradient(135deg,#00d4ff,#7c3aed);display:grid;place-items:center;color:#061017;font-weight:800">${(name[0]||'').toUpperCase()}</span>
          Hola, ${name}
        </span>
        <div id="acct-menu-pop" style="display:none;position:absolute;transform:translateY(6px);right:0;background:#0e1424;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px;box-shadow:0 12px 28px rgba(0,0,0,.45)">
          <a class="ghost" id="acct-logout-nav" style="display:block;padding:8px 10px">Cerrar sesi√≥n</a>
        </div>`;
      slot.style.position='relative';
      slot.innerHTML = S.user ? htmlLogged : htmlAnon;
      slot.querySelector('#acct-open-nav')?.addEventListener('click', ()=> openModal('login'));
      const userBtn=slot.querySelector('#acct-user-menu'); const pop=slot.querySelector('#acct-menu-pop');
      const toggle=()=>{ if(pop) pop.style.display=pop.style.display==='block'?'none':'block'; };
      userBtn?.addEventListener('click', toggle);
      document.addEventListener('click', e=>{ if(!slot.contains(e.target)){ if(pop) pop.style.display='none'; }});
      slot.querySelector('#acct-logout-nav')?.addEventListener('click', async e=>{
        e.preventDefault(); try{ await api('POST','/api/logout',{});}catch{} setUser(null); paintNav(); paintAccountSection();
      });
    }

    function paintAccountSection(){
      const statusEl = $('#acct-status'), nfcEl = $('#acct-nfc'), authCta = $('#acct-auth-cta');
      const portalRow = $('#acct-portal-row');
      const portalBtn = document.getElementById('portalBtn');

      if(!S.user){
        statusEl.textContent='Sesi√≥n no iniciada';
        nfcEl.textContent='NFC comprados: 0';
        if(authCta) authCta.style.display='block';
        if(portalRow) portalRow.style.display='none';
        if(portalBtn) portalBtn.style.display='none';
        return;
      }

      if(authCta) authCta.style.display='none';
      const active = isSubActive(S.user);
      statusEl.textContent = active ? prettyPlan(S.user) : 'Sin plan activo';
      const qty = Number(S.user.nfc_qty || 0); nfcEl.textContent = `NFC comprados: ${qty}`;

      if(portalRow) portalRow.style.display = active ? 'block' : 'none';
      if(portalBtn) portalBtn.style.display = active ? 'inline-flex' : 'none';
    }

    async function forceSessionRefresh(retries=4, delay=600){
      for(let i=0;i<retries;i++){
        try{
          const data=await api('GET','/api/session');
          if(data?.user){
            setUser(data.user);
            paintNav(); paintAccountSection();
            if(S.user.subscription || typeof S.user.nfc_qty==='number') break;
          }
        }catch{}
        await new Promise(r=>setTimeout(r,delay));
      }
    }

    function readParams(){
      const h = new URLSearchParams((location.hash||'').replace(/^#/, '').replace(/;/g,'&'));
      const q = new URLSearchParams(location.search.replace(/^\?/,'')); 
      return {
        google: h.get('google') || q.get('google') || null,
        from: (h.get('from') || q.get('from') || 'login').toLowerCase(),
        code: h.get('code') || q.get('code') || null,
        emailVerified: (h.get('email') === 'verified') || (q.get('email') === 'verified')
      };
    }
    function showTopBanner(text, type='ok'){
      const b = document.getElementById('top-banner');
      const t = document.getElementById('top-banner-text');
      if(!b||!t) return;
      b.classList.remove('err','warn'); if(type!=='ok') b.classList.add(type);
      t.innerHTML = text; b.classList.add('show');
    }
    function clearUrl(){ try{ history.replaceState(null,'',location.pathname); }catch{} }

    function msgFromGoogleCode(code, from){
      const isReg = from==='register';
      switch(code){
        case 'email_in_use_password': return isReg ? 'Ese correo ya est√° registrado con contrase√±a. Inicia sesi√≥n con correo y contrase√±a.' : 'Esa cuenta no est√° vinculada a Google. Inicia con correo y contrase√±a.';
        case 'email_in_use_google': return 'Ese correo ya est√° registrado con Google. Inicia sesi√≥n con Google.';
        case 'email_in_use': return isReg ? 'Ese correo ya existe. Inicia sesi√≥n.' : 'Ese correo ya existe.';
        case 'not_registered': return 'No existe ninguna cuenta con ese correo. Reg√≠strate primero.';
        case 'email_not_verified': return 'Tu correo de Google no est√° verificado.';
        case 'google_auth_failed': return 'No se pudo conectar con Google. Int√©ntalo de nuevo.';
        default: return 'No se pudo completar con Google. Int√©ntalo de nuevo.';
      }
    }

    async function handleSignals(){
      const s = readParams();

      if(s.emailVerified){
        await forceSessionRefresh();
        showTopBanner('¬°Correo verificado! Tu cuenta est√° activada. üéâ', 'ok');
        clearUrl();
      }

      if(!s.google) return;
      if(s.google==='ok'){
        await forceSessionRefresh();
        showTopBanner('Sesi√≥n iniciada con Google.', 'ok');
      }else{
        openModal(s.from === 'register' ? 'register' : 'login');
        const target = (s.from === 'register') ? errs.register : errs.login;
        if(target){
          target.textContent = msgFromGoogleCode(s.code, s.from);
          target.style.display = 'block';
        }
      }
      clearUrl();
    }

    async function getSession(){
      const cached=readUser(); if(cached){ setUser(cached); paintNav(); paintAccountSection(); }
      try{ const data=await api('GET','/api/session'); setUser(data?.user||null); }catch{ setUser(cached||null); }
      paintNav(); paintAccountSection();

      document.body.addEventListener('click',(e)=>{
        const g=e.target.closest('.acct-guard'); if(g && !S.user){ e.stopImmediatePropagation(); e.preventDefault(); openModal('login'); }
      }, true);

      await handleSignals();
    }

    window.addEventListener('storage', e=>{
      if(e.key==='acct_user'){
        try{ setUser(e.newValue ? JSON.parse(e.newValue) : null); }catch{ setUser(null); }
        paintNav(); paintAccountSection();
      }
    });

    // --- Portal Stripe ---
    async function openPortal(){
      try{
        const res = await fetch('/api/portal', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include' });
        const data = await res.json();
        if(res.ok && data?.url){ location.href = data.url; return; }
      }catch{}
      location.href = 'https://billing.stripe.com/p/login/test_28E28sevk0OcdGMdkX4ko00';
    }
    document.getElementById('portalBtn')?.addEventListener('click', async (e)=>{
      if(!S.user){ e.preventDefault(); openModal('login'); return; }
      await openPortal();
    });
    document.getElementById('portalBtnAccount')?.addEventListener('click', async (e)=>{
      if(!S.user){ e.preventDefault(); openModal('login'); return; }
      await openPortal();
    });

    getSession();
  })();

  // -------- Pago suscripciones (B√ÅSICO y PRO) --------
  $$('.btn.plan').forEach(btn => btn.addEventListener('click', async () => {
    const tier = btn.dataset.tier;
    const frequency = (document.querySelector('#btn-year')?.classList.contains('active')) ? 'annual' : 'monthly';

    if (window.taplyAuth?.user && (window.taplyAuth.user.subscription || window.taplyAuth.user.isSubscribed)) {
      if (confirm('Ya tienes una suscripci√≥n activa. ¬øQuieres abrir el portal para gestionarla?')) {
        try{
          const r=await fetch('/api/portal',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include'});
          const d=await r.json(); if(r.ok && d?.url){ location.href=d.url; return; }
          location.href='https://billing.stripe.com/p/login/test_28E28sevk0OcdGMdkX4ko00';
        }catch{
          location.href='https://billing.stripe.com/p/login/test_28E28sevk0OcdGMdkX4ko00';
        }
      }
      return;
    }

    try {
      const res = await fetch('/api/create-checkout-session', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ tier, frequency })
      });
      const data = await res.json();
      if (!res.ok) { alert(data?.error || 'Error iniciando la suscripci√≥n'); return; }
      if (data?.url) location.href = data.url; else alert('No se gener√≥ la URL de Stripe (no_session_url)');
    } catch { alert('Error de red al iniciar la suscripci√≥n'); }
  }));

  // -------- Pago NFC --------
  document.getElementById('buyNfcBtn').addEventListener('click', async () => {
    try {
      const res = await fetch('/api/buy-nfc', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ quantity: qty }) });
      const data = await res.json();
      if (!res.ok) { alert(data?.error || 'Error iniciando el pago de NFC'); return; }
      if (data?.url) location.href = data.url; else alert('No se gener√≥ la URL de Stripe (no_session_url)');
    } catch { alert('Error de red al iniciar el pago de NFC'); }
  });
</script>
</body>
</html>
