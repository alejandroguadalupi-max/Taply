<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>Taply — NFC + Suscripción</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f1a; --bg-2:#0e1424; --txt:#e9eefc; --muted:#9fb0c6;
      --brand-1:#00d4ff; --brand-2:#7c3aed; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --border:rgba(255,255,255,.08); --radius:18px;
      --shadow:0 12px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
      --focus:0 0 0 3px rgba(0,212,255,.25),0 0 0 6px rgba(124,58,237,.18);
    }
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--txt);opacity:0;transition:.35s}
    body.is-loaded{opacity:1}
    a{text-decoration:none;color:inherit}
    .container{max-width:1100px;width:92%;margin-inline:auto}

    header{padding:14px 0;border-bottom:1px solid var(--border);background:#0a0f16cc;backdrop-filter:blur(10px)}
    .brand{font-weight:800;display:flex;align-items:center;gap:8px;justify-content:space-between}
    .logo{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand-1),var(--brand-2))}

    .hero{text-align:center;padding:40px 0 24px}
    .h1{font-size:clamp(2rem,5.5vw,3.2rem);margin:0;font-weight:800}
    .lead{color:var(--muted);max-width:860px;margin:12px auto 0}

    .steps{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:18px 0}
    .step-pill{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.04);font-weight:600}
    .n{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand-1),var(--brand-2));color:#061017;font-size:12px}

    .chooser{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin:24px auto}
    .card{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;display:flex;flex-direction:column;justify-content:space-between}
    .card h3{margin:0 0 6px;font-size:1.2rem}
    .card p{margin:0;color:var(--muted)}
    .badge{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04);color:#cfe3ff;display:inline-block;margin-bottom:8px}
    .actions{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    .btn{
      padding:12px 16px;border:0;border-radius:999px;font-weight:800;cursor:pointer;display:inline-flex;justify-content:center;align-items:center;
      background:linear-gradient(135deg,var(--brand-1),var(--brand-2));color:#061017;box-shadow:0 10px 28px rgba(124,58,237,.35),0 4px 14px rgba(0,212,255,.25);
      touch-action:manipulation; -webkit-tap-highlight-color:transparent; user-select:none; font-size:16px
    }
    .btn:focus-visible{outline:none; box-shadow:var(--focus)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--txt);box-shadow:none}
    .seg{display:flex;justify-content:center;gap:10px;margin:22px auto}
    .seg button{border:0;padding:10px 18px;border-radius:999px;font-weight:700;cursor:pointer;background:rgba(255,255,255,.06);color:var(--muted);touch-action:manipulation;font-size:16px}
    .seg button.active{background:linear-gradient(135deg,var(--brand-1),var(--brand-2));color:#061017}

    .plan-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;align-items:stretch}
    .plan{display:flex;flex-direction:column;justify-content:space-between}
    .price-lg{font-size:32px;font-weight:800;margin:8px 0}
    .per{color:var(--muted);font-size:14px;font-weight:600}
    .desc{color:var(--muted);flex:1;margin:8px 0 12px}
    .plan.rec{outline:2px solid rgba(0,212,255,.25);box-shadow:0 0 0 5px rgba(124,58,237,.08),var(--shadow)}

    footer{text-align:center;padding:28px 0 36px;color:#b7c3d2;border-top:1px solid var(--border)}
    @media(max-width:700px){.btn,.btn.ghost{width:100%}}

    .panel{display:none;margin-bottom:40px}
    .panel.show{display:block}

    /* === MODAL / CUENTA (mejorado) === */
    #acct-modal.acct-hidden{display:none!important}
    #acct-modal{position:fixed;inset:0;background:rgba(6,10,18,.6);backdrop-filter:blur(8px);display:grid;place-items:center;z-index:1000}
    .acct-dialog{width:min(560px,92%);background:var(--bg-2,#0e1424);color:var(--txt,#e9eefc);
      border:1px solid var(--border,rgba(255,255,255,.08));border-radius:16px;box-shadow:var(--shadow);padding:20px}
    .acct-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .acct-x{background:transparent;border:0;color:inherit;font-size:22px;cursor:pointer}
    .acct-tabs{display:flex;gap:8px;margin:10px 0 12px}
    .acct-tab{border:1px solid var(--border,rgba(255,255,255,.12));background:rgba(255,255,255,.04);
      border-radius:999px;padding:8px 12px;cursor:pointer;color:inherit;font-weight:700}
    .acct-tab.acct-tab-active{background:linear-gradient(135deg,var(--brand-1,#00d4ff),var(--brand-2,#7c3aed)); color:#061017}
    .acct-form{display:grid;gap:10px}
    .acct-form label{display:grid;gap:6px;font-weight:600}
    .acct-input{position:relative}
    .acct-input input{
      width:100%;background:#0a0f16;border:1px solid var(--border,rgba(255,255,255,.12));color:inherit;border-radius:12px;padding:12px 42px 12px 12px;font-size:16px;
      transition:border .2s, box-shadow .2s
    }
    .acct-input input:focus{outline:none;border-color:rgba(0,212,255,.45); box-shadow:var(--focus)}
    input,select,textarea,button{font-size:16px}
    .toggle-eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:#cfe3ff;cursor:pointer}
    .acct-msg{color:#cfe3ff;margin:0 0 8px;font-size:.95rem}
    .acct-err{color:var(--err);margin-top:4px}
    .acct-small{color:var(--muted,#9fb0c6);font-size:.92rem;margin-top:6px}
    .acct-link{color:#b3e1ff;text-decoration:underline;cursor:pointer}
    .meter{height:8px;border-radius:8px;background:#101826;border:1px solid rgba(255,255,255,.08);overflow:hidden}
    .meter > i{display:block;height:100%;width:0%;background:#ef4444;transition:width .25s, background .25s}
    .row-between{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .ok{color:#86efac}

    /* Mi cuenta */
    .acct-row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .acct-badge{display:inline-block;border:1px solid var(--border,rgba(255,255,255,.12));background:rgba(255,255,255,.04);padding:6px 10px;border-radius:999px;font-weight:800}
  </style>
</head>
<body>
<header>
  <div class="container brand">
    <div style="display:flex;align-items:center;gap:8px">
      <a href="index.html" aria-label="Inicio" style="display:flex;align-items:center;gap:8px;color:inherit">
        <span class="logo"><svg viewBox="0 0 24 24" fill="none"><path d="M5 12a7 7 0 1114 0v6.5a2.5 2.5 0 01-5 0V9.75a2.25 2.25 0 10-4.5 0V18.5a2.5 2.5 0 01-5 0V12z" stroke="#061017" stroke-width="1.7"/></svg></span>
        <span>taply</span>
      </a>
    </div>
    <nav class="nav-links" style="display:flex;gap:12px;align-items:center">
      <span id="acct-nav-slot" style="position:relative"></span>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1 class="h1">Empieza en dos pasos</h1>
    <p class="lead">Primero compra los NFC para tus mesas, después activa la suscripción que más te convenga. Son pagos independientes y tras cada compra recibirás un WhatsApp con instrucciones y contacto directo.</p>
    <div class="steps">
      <span class="step-pill"><span class="n">1</span> Comprar NFC</span>
      <span class="step-pill"><span class="n">2</span> Elegir suscripción</span>
    </div>

    <div class="chooser">
      <article class="card">
        <span class="badge">Paso 1</span>
        <h3>Comprar NFC</h3>
        <p>Dispositivos que colocas en las mesas o mostradores. Pago único, necesarios para empezar.</p>
        <div class="actions">
          <a href="#" id="showNfc" class="btn">Comprar NFC</a>
        </div>
      </article>
      <article class="card">
        <span class="badge">Paso 2</span>
        <h3>Activar Suscripción</h3>
        <p>Elige plan mensual o anual para gestionar reseñas, panel privado y más. Una vez tengas NFC.</p>
        <div class="actions">
          <a href="#" id="showSub" class="btn">Ver planes</a>
        </div>
      </article>
    </div>
  </div>
</section>

<section id="panel-nfc" class="panel container">
  <article class="card">
    <h3>Compra tus NFC</h3>
    <p class="desc">Selecciona cuántos necesitas. Tras pagar recibirás WhatsApp automático con la guía.</p>
    <div class="actions" style="justify-content:center;gap:16px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px;border-radius:999px">
        <button id="minus" class="btn ghost" style="padding:6px 12px" aria-label="Quitar uno">−</button>
        <span id="qty" aria-live="polite" style="min-width:2ch;text-align:center;display:inline-block">1</span>
        <button id="plus" class="btn ghost" style="padding:6px 12px" aria-label="Añadir uno">＋</button>
      </div>
      <div class="price">Total: <span id="totalNfc">—</span></div>
      <a class="btn acct-guard" id="buyNfcBtn">Comprar ahora</a>
    </div>
    <p style="font-size:14px;text-align:center;margin-top:10px">Precio unitario: <strong id="unitPrice">—</strong></p>
  </article>
</section>

<section id="panel-sub" class="panel container">
  <div class="seg" role="tablist" aria-label="Frecuencia de facturación">
    <button id="btn-month" class="active" role="tab" aria-selected="true">Mensual</button>
    <button id="btn-year" role="tab" aria-selected="false">Anual · ahorra</button>
  </div>

  <div class="plan-grid">
    <article class="card plan">
      <span class="badge">Básico</span>
      <div class="price-lg"><span id="p-basic">25€</span> <span class="per">/mes</span></div>
      <p class="desc">Empieza a captar reseñas con tu NFC listo y acceso a tus datos exportables.</p>
      <div class="actions"><a class="btn plan acct-guard" data-tier="basic">Elegir Básico</a></div>
    </article>

    <article class="card plan rec">
      <span class="badge">Medio · Recomendado</span>
      <div class="price-lg"><span id="p-medio">35€</span> <span class="per">/mes</span></div>
      <p class="desc">Todo lo de Básico más un panel privado con filtros para controlar mejor tu reputación.</p>
      <div class="actions"><a class="btn plan acct-guard" data-tier="medio">Elegir Medio</a></div>
    </article>

    <article class="card plan">
      <span class="badge">Pro</span>
      <div class="price-lg"><span id="p-pro">45€</span> <span class="per">/mes</span></div>
      <p class="desc">Todo lo de Medio con integración en Telegram, cambios bajo demanda y opción de incentivo para clientes.</p>
      <div class="actions"><a class="btn plan acct-guard" data-tier="pro">Elegir Pro</a></div>
    </article>
  </div>
</section>

<!-- === RESUMEN DE CUENTA (ligero) === -->
<section id="cuenta" class="container" style="padding:40px 0">
  <article class="card">
    <h3 style="margin:0 0 6px">Mi suscripción</h3>
    <p class="desc">Gestiona tu suscripción y tus datos de acceso.</p>

    <div class="acct-row" style="margin:12px 0 6px">
      <div>
        <div id="acct-status" class="acct-badge">Sesión no iniciada</div>
        <div id="acct-email" class="acct-small">—</div>
        <div id="acct-plan" class="acct-small"></div>
        <div id="acct-nfc" class="acct-small"></div>
      </div>
      <div class="actions">
        <a href="gestionar.html" id="acct-manage" class="btn acct-guard">Gestionar suscripción</a>
        <button id="acct-logout" class="btn ghost">Cerrar sesión</button>
      </div>
    </div>

    <p id="acct-renews" class="acct-small"></p>
    <p class="acct-small">¿No tienes cuenta? <a id="acct-open-from-section" class="acct-link">Inicia sesión o regístrate</a>.</p>
  </article>
</section>

<footer>
  <div class="container">
    <p>Primero los dispositivos NFC, después la suscripción. Tras cada compra recibirás WhatsApp con instrucciones.</p>
  </div>
</footer>

<!-- === MODAL CUENTA === -->
<div id="acct-modal" class="acct-hidden" role="dialog" aria-modal="true" aria-labelledby="acct-title">
  <div class="acct-dialog">
    <div class="acct-head">
      <h3 id="acct-title" style="margin:0">Tu cuenta</h3>
      <button id="acct-close" class="acct-x" aria-label="Cerrar">×</button>
    </div>
    <p id="acct-msg" class="acct-msg">Inicia sesión o crea tu cuenta.</p>

    <div class="acct-tabs" role="tablist">
      <button class="acct-tab acct-tab-active" data-tab="login" role="tab" aria-selected="true">Iniciar sesión</button>
      <button class="acct-tab" data-tab="register" role="tab" aria-selected="false">Crear cuenta</button>
      <button class="acct-tab" data-tab="recover" role="tab" aria-selected="false">Recuperar</button>
    </div>

    <!-- LOGIN -->
    <form id="acct-form-login" class="acct-form" autocomplete="on" novalidate>
      <label>Email
        <span class="acct-input">
          <input id="acct-login-email" type="email" required autocomplete="email" inputmode="email" placeholder="tucorreo@ejemplo.com">
        </span>
      </label>
      <label>Contraseña
        <span class="acct-input">
          <input id="acct-login-pass" type="password" required autocomplete="current-password" placeholder="••••••••">
          <button type="button" class="toggle-eye" data-toggle="#acct-login-pass" aria-label="Mostrar u ocultar contraseña">👁</button>
        </span>
      </label>
      <div class="row-between">
        <button type="submit" class="btn">Entrar</button>
        <span class="acct-link" id="acct-forgot">¿Olvidaste la contraseña?</span>
      </div>
      <p class="acct-small">¿Prefieres página aparte? <a class="acct-link" href="login.html">Ir a iniciar sesión</a></p>
      <p id="acct-error-login" class="acct-err" style="display:none"></p>
    </form>

    <!-- REGISTER -->
    <form id="acct-form-register" class="acct-form" style="display:none" autocomplete="on" novalidate>
      <label>Nombre <input id="acct-reg-name" type="text" required autocomplete="name" placeholder="Nombre y apellidos"></label>
      <label>Email <input id="acct-reg-email" type="email" required autocomplete="email" inputmode="email" placeholder="tucorreo@ejemplo.com"></label>
      <label>Contraseña
        <span class="acct-input">
          <input id="acct-reg-pass" type="password" required minlength="6" autocomplete="new-password" placeholder="Mínimo 6 caracteres">
          <button type="button" class="toggle-eye" data-toggle="#acct-reg-pass">👁</button>
        </span>
      </label>
      <label>Confirmar contraseña
        <span class="acct-input">
          <input id="acct-reg-pass2" type="password" required minlength="6" autocomplete="new-password" placeholder="Repite la contraseña">
          <button type="button" class="toggle-eye" data-toggle="#acct-reg-pass2">👁</button>
        </span>
      </label>
      <div class="meter" aria-hidden="true"><i id="pw-meter"></i></div>
      <button type="submit" class="btn">Crear cuenta</button>
      <p class="acct-small">¿Prefieres página aparte? <a class="acct-link" href="registro.html">Ir a registrarse</a></p>
      <p id="acct-error-register" class="acct-err" style="display:none"></p>
    </form>

    <!-- RECOVER -->
    <form id="acct-form-recover" class="acct-form" style="display:none" autocomplete="on" novalidate>
      <p class="acct-msg">Te enviaremos un enlace para restablecer tu contraseña.</p>
      <label>Email <input id="acct-recover-email" type="email" required autocomplete="email" inputmode="email" placeholder="tucorreo@ejemplo.com"></label>
      <div class="row-between">
        <button type="submit" class="btn">Enviar enlace</button>
        <span class="acct-link" data-tab-go="login">Volver a iniciar sesión</span>
      </div>
      <p id="acct-info-recover" class="ok" style="display:none"></p>
      <p id="acct-error-recover" class="acct-err" style="display:none"></p>
    </form>
  </div>
</div>

<!-- === LÓGICA DE PÁGINA (NFC + precios + Stripe) === -->
<script>
  const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
  const fmt=v=>new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(v);
  window.addEventListener('load',()=>document.body.classList.add('is-loaded'));

  const PRICE={nfcUnit:5,monthly:{basic:25,medio:35,pro:45},annualDiscount:.20};
  let qty=1,yearly=false;

  // Mostrar paneles
  $('#showNfc').addEventListener('click',e=>{
    e.preventDefault();
    $('#panel-nfc').classList.add('show');
    $('#panel-sub').classList.remove('show');
    $('#panel-nfc').scrollIntoView({behavior:'smooth'});
  });
  $('#showSub').addEventListener('click',e=>{
    e.preventDefault();
    $('#panel-sub').classList.add('show');
    $('#panel-nfc').classList.remove('show');
    $('#panel-sub').scrollIntoView({behavior:'smooth'});
  });

  // NFC UX (stepper con autorepeat y sin ghost click)
  function paintNfc(){
    $('#qty').textContent=qty;
    $('#totalNfc').textContent=fmt(qty*PRICE.nfcUnit)+' (pago único)';
    $('#unitPrice').textContent=fmt(PRICE.nfcUnit)+' por dispositivo';
  }
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function changeQty(delta){ qty = clamp(qty + delta, 1, 999); paintNfc(); }
  function attachStepper(btn, delta){
    let t1=null, t2=null, pressed=false;
    const start=()=>{ pressed=true; changeQty(delta); t1=setTimeout(()=>{ t2=setInterval(()=>changeQty(delta), 60); }, 300); };
    const stop =()=>{ pressed=false; clearTimeout(t1); clearInterval(t2); t1=t2=null; };
    btn.addEventListener('pointerdown', e=>{ e.preventDefault(); start(); });
    ['pointerup','pointercancel','pointerleave','blur'].forEach(ev=>btn.addEventListener(ev, stop));
    btn.addEventListener('click', e=>{ if(pressed){ e.preventDefault(); e.stopPropagation(); } }, true);
  }
  attachStepper($('#minus'), -1);
  attachStepper($('#plus'), +1);
  paintNfc();

  // Toggle mensual/anual
  function planAmount(tier){const m=PRICE.monthly[tier];return yearly?Math.round(m*12*(1-PRICE.annualDiscount)):m}
  function paintPrices(){
    $('#p-basic').textContent=yearly?fmt(planAmount('basic')):PRICE.monthly.basic+'€';
    $('#p-medio').textContent=yearly?fmt(planAmount('medio')):PRICE.monthly.medio+'€';
    $('#p-pro').textContent=yearly?fmt(planAmount('pro')):PRICE.monthly.pro+'€';
    $$('.per').forEach(el=>el.textContent=yearly?'/año':'/mes');
  }
  $('#btn-month').addEventListener('click',()=>{
    yearly=false;$('#btn-month').classList.add('active');$('#btn-year').classList.remove('active');
    $('#btn-month').setAttribute('aria-selected','true'); $('#btn-year').setAttribute('aria-selected','false');
    paintPrices()
  });
  $('#btn-year').addEventListener('click',()=>{
    yearly=true;$('#btn-year').classList.add('active');$('#btn-month').classList.remove('active');
    $('#btn-year').setAttribute('aria-selected','true'); $('#btn-month').setAttribute('aria-selected','false');
    paintPrices()
  });
  paintPrices();

  // Pago NFC (si no hay sesión, el gating lo corta abajo)
  $('#buyNfcBtn').addEventListener('click', async () => {
    try {
      const res = await fetch('/api/buy-nfc', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity: qty })
      });
      const data = await res.json();
      if (!res.ok) { alert(data?.error || 'Error iniciando el pago de NFC'); return; }
      if (data?.url) location.href = data.url; else alert('No se generó la URL de Stripe (no_session_url)');
    } catch { alert('Error de red al iniciar el pago de NFC'); }
  });

  // Pago suscripciones
  $$('.btn.plan').forEach(btn => btn.addEventListener('click', async () => {
    const tier = btn.dataset.tier;
    const frequency = yearly ? 'annual' : 'monthly';

    if (window.taplyAuth?.user && isSubActive(window.taplyAuth.user)) {
      const u = window.taplyAuth.user;
      const planName = prettyPlan(u) || 'actual';
      const info = `Ya tienes un plan ${planName} activo.\n\n¿Quieres ir a “Gestionar suscripción” para cambiarlo?`;
      const goManage = confirm(info);
      if (goManage) { location.href = 'gestionar.html'; return; }
    }

    try {
      const res = await fetch('/api/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tier, frequency })
      });
      const data = await res.json();
      if (!res.ok) {
        if (data?.error === 'already_subscribed') {
          if (confirm('Ya tienes una suscripción activa. ¿Abrir la página de gestión?')) location.href='gestionar.html';
          return;
        }
        alert(data?.error || 'Error iniciando la suscripción'); return;
      }
      if (data?.url) location.href = data.url; else alert('No se generó la URL de Stripe (no_session_url)');
    } catch { alert('Error de red al iniciar la suscripción'); }
  }));
</script>

<!-- === AUTH + MENÚ + GATING (login requerido) === -->
<script>
(function(){
  const S = { user:null };

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmtDate = (d)=> new Intl.DateTimeFormat('es-ES',{dateStyle:'medium'}).format(d);

  /* === Helpers de fecha === */
  function addDays(date, days){ const x = new Date(date); x.setDate(x.getDate()+days); return x; }
  function getInterval(u){
    return (u?.subscription?.price?.interval ||
            u?.subscription?.plan?.interval ||
            u?.subscription_interval || 'month').toLowerCase();
  }
  // Renovación a 30 días (o 365 días si anual)
  function computeNextRenewal30(u){
    const start = u?.subscription?.current_period_start || u?.subscription_start || u?.subscription_created;
    if(!start) return null;
    const startDate = typeof start==='number' ? new Date(start*1000) : new Date(start);
    const interval = getInterval(u);
    return interval==='year' ? addDays(startDate, 365) : addDays(startDate, 30);
  }

  /* === Plan pretty === */
  function prettyPlan(u){
    const nick = (u?.subscription?.plan?.nickname || u?.subscription?.price?.nickname || u?.plan || '').toLowerCase();
    let base = 'Básico';
    if(/pro/.test(nick)) base = 'Pro';
    else if(/medio|standard|estándar/.test(nick)) base = 'Medio';
    else if(/basic|básico|basico/.test(nick)) base = 'Básico';
    const freq = getInterval(u)==='year' ? 'anual' : 'mensual';
    return `${base} ${freq}`;
  }
  function isSubActive(u){
    const s = (u?.subscription?.status || u?.subscription_status || '').toLowerCase();
    return s === 'active' || s === 'trialing' || s === 'past_due' || u?.isSubscribed === true;
  }

  /* === Modal === */
  const modal = $('#acct-modal');
  const msg = $('#acct-msg');
  const tabBtns = $$('#acct-modal .acct-tab');
  const forms = {
    login:   $('#acct-form-login'),
    register:$('#acct-form-register'),
    recover: $('#acct-form-recover'),
  };
  const errs = {
    login:   $('#acct-error-login'),
    register:$('#acct-error-register'),
    recover: $('#acct-error-recover'),
  };
  const okRecover = $('#acct-info-recover');

  function setTab(name){
    Object.entries(forms).forEach(([k,f])=> f.style.display = (k===name?'grid':'none'));
    tabBtns.forEach(b=>{
      const on = b.dataset.tab===name; b.classList.toggle('acct-tab-active',on); b.setAttribute('aria-selected', String(on));
    });
  }
  function openModal(text, tab='login'){
    msg.textContent = text || 'Accede a tu cuenta';
    modal.classList.remove('acct-hidden');
    setTab(tab);
    setTimeout(()=>$('#acct-login-email')?.focus(),40);
  }
  function closeModal(){
    modal.classList.add('acct-hidden');
    Object.values(errs).forEach(e=> e && (e.style.display='none'));
    okRecover.style.display='none';
  }
  $('#acct-close')?.addEventListener('click', closeModal);
  modal?.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
  tabBtns.forEach(b => b.addEventListener('click', ()=> setTab(b.dataset.tab)));
  document.querySelectorAll('[data-tab-go]').forEach(el=> el.addEventListener('click', ()=> setTab(el.getAttribute('data-tab-go')) ));
  $('#acct-forgot')?.addEventListener('click', ()=>{
    const email = $('#acct-login-email')?.value || '';
    setTab('recover'); const input = $('#acct-recover-email'); if(input&&email) input.value = email;
  });

  // Ver/ocultar pass + medidor
  $$('.toggle-eye').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const sel = btn.getAttribute('data-toggle'); const input = document.querySelector(sel);
      if(!input) return; input.type = input.type === 'password' ? 'text' : 'password';
    });
  });
  const meter = $('#pw-meter');
  $('#acct-reg-pass')?.addEventListener('input', (e)=>{
    const v = e.target.value || ''; let score = 0;
    if(v.length >= 6) score += 33;
    if(/[A-Z]/.test(v) && /[a-z]/.test(v)) score += 33;
    if(/\d/.test(v) || /[^A-Za-z0-9]/.test(v)) score += 34;
    if(meter){ meter.style.width = Math.min(100, score) + '%'; meter.style.background = score>80?'#22c55e':score>50?'#f59e0b':'#ef4444'; }
  });

  async function api(method, url, body){
    const res = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: body?JSON.stringify(body):undefined });
    let data=null; try{ data = await res.json(); }catch{}
    if(!res.ok) throw (data?.error || `HTTP ${res.status}`);
    return data;
  }

  /* === Top-right account nav === */
  function paintNav(){
    const slots = ['#acct-nav-slot'].map(s=>document.querySelector(s)).filter(Boolean);
    const htmlAnon = `<a class="btn ghost" id="acct-open-nav">Iniciar sesión</a>`;
    const name = (S.user?.name || S.user?.email || '').split(' ')[0] || 'Mi cuenta';
    const htmlLogged = `
      <span class="btn ghost" id="acct-user-menu" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
        <span style="width:28px;height:28px;border-radius:999px;background:linear-gradient(135deg,#00d4ff,#7c3aed);display:grid;place-items:center;color:#061017;font-weight:800">
          ${(name[0]||'').toUpperCase()}
        </span>
        Hola, ${name}
      </span>
      <div id="acct-menu-pop" style="display:none;position:absolute;transform:translateY(6px);background:#0e1424;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px;box-shadow:0 12px 28px rgba(0,0,0,.45)">
        <a class="ghost" href="gestionar.html" style="display:block;padding:8px 10px">Gestionar suscripción</a>
        <a class="ghost" id="acct-logout-nav" style="display:block;padding:8px 10px">Cerrar sesión</a>
      </div>
    `;
    slots.forEach(slot=>{
      slot.style.position = 'relative';
      slot.innerHTML = S.user ? htmlLogged : htmlAnon;

      slot.querySelector('#acct-open-nav')?.addEventListener('click', ()=> openModal('Accede para continuar'));

      const userBtn = slot.querySelector('#acct-user-menu');
      const pop = slot.querySelector('#acct-menu-pop');
      const toggle = ()=>{ if(pop) pop.style.display = pop.style.display==='block'?'none':'block'; };
      userBtn?.addEventListener('click', toggle);
      document.addEventListener('click', (e)=>{ if(!slot.contains(e.target)){ if(pop) pop.style.display='none'; } });

      slot.querySelector('#acct-logout-nav')?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try{ await api('POST','/api/logout',{});}catch{}
        S.user = null; paintNav(); paintAccountSection();
      });
    });
  }

  /* === Sesión + gating (sin auto-checkout tras login) === */
  async function getSession(){
    try{ const data = await api('GET','/api/session'); S.user = data?.user || null; }
    catch{ S.user = null; }
    paintNav(); paintAccountSection();

    // Gating de compras: si no hay sesión -> abrir modal y NO relanzar acción
    const requireLogin = (ev) => {
      if(!S.user){
        ev.stopImmediatePropagation(); ev.preventDefault();
        openModal('Inicia sesión o regístrate para continuar.');
        return true;
      } return false;
    };

    // Proteger todos los botones de compra/planes/gestión
    document.body.addEventListener('click',(e)=>{
      const guarded = e.target.closest('.acct-guard');
      if(guarded) requireLogin(e);
    }, true);
  }

  // Forms
  forms.login?.addEventListener('submit', async (e)=>{
    e.preventDefault(); errs.login.style.display='none';
    const email = $('#acct-login-email').value.trim();
    const password = $('#acct-login-pass').value;
    try{
      const data = await api('POST','/api/login',{ email, password });
      S.user = data?.user || null; paintNav(); paintAccountSection(); closeModal();
      // No relanzamos la acción que abrió el modal: te quedas en esta página.
    }catch(err){
      errs.login.textContent = (err==='account_not_found') ? 'No existe una cuenta con ese email.' :
                               (err==='invalid_credentials') ? 'Contraseña incorrecta.' :
                               (err==='password_not_set') ? 'Esta cuenta no tiene contraseña. Usa “Recuperar”.' :
                               String(err);
      errs.login.style.display='block';
    }
  });

  forms.register?.addEventListener('submit', async (e)=>{
    e.preventDefault(); errs.register.style.display='none';
    const name = $('#acct-reg-name').value.trim();
    const email = $('#acct-reg-email').value.trim();
    const p1 = $('#acct-reg-pass').value;
    const p2 = $('#acct-reg-pass2').value;
    if(p1 !== p2){ errs.register.textContent='Las contraseñas no coinciden.'; errs.register.style.display='block'; return; }
    if(p1.length < 6){ errs.register.textContent='La contraseña debe tener al menos 6 caracteres.'; errs.register.style.display='block'; return; }
    if(!name){ errs.register.textContent='El nombre es obligatorio.'; errs.register.style.display='block'; return; }
    try{
      const data = await api('POST','/api/register',{ name, email, password: p1 });
      S.user = data?.user || null; paintNav(); paintAccountSection(); closeModal();
    }catch(err){
      errs.register.textContent = (err==='email_in_use') ? 'Ese correo ya tiene una cuenta. Inicia sesión.' :
                                  (err==='weak_password') ? 'La contraseña debe tener al menos 6 caracteres.' :
                                  (err==='name_email_password_required') ? 'Nombre, email y contraseña son obligatorios.' :
                                  String(err);
      errs.register.style.display='block';
    }
  });

  forms.recover?.addEventListener('submit', async (e)=>{
    e.preventDefault(); errs.recover.style.display='none'; okRecover.style.display='none';
    const email = $('#acct-recover-email').value.trim();
    try{
      await api('POST','/api/request-password-reset',{ email });
      okRecover.textContent = 'Si el correo está registrado, te hemos enviado un enlace para restablecer la contraseña.';
      okRecover.style.display='block';
    }catch(err){
      errs.recover.textContent = String(err); errs.recover.style.display='block';
    }
  });

  /* === Bloque “Mi suscripción” === */
  function paintAccountSection(){
    const emailEl = $('#acct-email');
    const statusEl = $('#acct-status');
    const renewsEl = $('#acct-renews');
    const planEl = $('#acct-plan');
    const nfcEl = $('#acct-nfc');
    const logoutBtn = $('#acct-logout');

    if(!emailEl || !statusEl) return;

    if(!S.user){
      emailEl.textContent = '—';
      statusEl.textContent = 'Sesión no iniciada';
      renewsEl.textContent = '';
      planEl.textContent = '';
      nfcEl.textContent = '';
      logoutBtn?.setAttribute('disabled','disabled');
      return;
    }
    logoutBtn?.removeAttribute('disabled');
    logoutBtn.onclick = async ()=> {
      try{ await api('POST','/api/logout',{}); }catch{}
      S.user = null; paintNav(); paintAccountSection();
      alert('Sesión cerrada');
    };

    emailEl.textContent = S.user.email || '—';
    const st = (S.user.subscription?.status || S.user.subscription_status || 'none').toLowerCase();
    const prettyStatus = isSubActive(S.user) ? 'Suscripción activa' : (st==='canceled'?'Suscripción cancelada':'Sin suscripción');
    statusEl.textContent = prettyStatus;

    // Plan exacto (“Básico mensual/anual”)
    planEl.textContent = S.user.subscription ? `Plan: ${prettyPlan(S.user)}` : '';

    // Renovación a 30 días desde inicio de periodo
    const next = computeNextRenewal30(S.user);
    renewsEl.textContent = next ? `Renovación / fin de periodo: ${fmtDate(next)}.` : '';

    // NFC comprados (desde metadata)
    const qty = Number(S.user.nfc_qty || 0);
    nfcEl.textContent = `NFC comprados: ${qty}`;
  }

  document.getElementById('acct-open-from-section')?.addEventListener('click', ()=> openModal());

  // Exposición mínima
  window.taplyAuth = { open: openModal, close: closeModal, get user(){ return S.user; } };
  window.isSubActive = isSubActive;
  window.prettyPlan = prettyPlan;

  // Arranque
  getSession();
})();
</script>
</body>
</html>


