<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>Taply — NFC + Suscripción</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b0f1a; --bg-2:#0e1424; --txt:#e9eefc; --muted:#9fb0c6; --brand-1:#00d4ff; --brand-2:#7c3aed; --ok:#22c55e; --border:rgba(255,255,255,.08); --radius:18px; --shadow:0 12px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04) }
    *{box-sizing:border-box} html,body{height:100%;touch-action:manipulation}
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--txt);opacity:0;transition:.35s}
    body.is-loaded{opacity:1} a{text-decoration:none;color:inherit} .container{max-width:1100px;width:92%;margin-inline:auto}
    header{position:sticky;top:0;z-index:60;background:#0a0f16cc;border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(10px)}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:14px 0;position:relative}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800}
    .logo{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand-1),var(--brand-2))}
    .nav-links{display:flex;gap:22px;align-items:center}
    .ghost{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:var(--txt)}
    .btn{background:linear-gradient(135deg,var(--brand-1),var(--brand-2));color:#061017;font-weight:800;border:0;border-radius:999px;cursor:pointer;padding:12px 16px;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 10px 28px rgba(124,58,237,.35),0 4px 14px rgba(0,212,255,.25)}
    .btn.sm{padding:6px 12px;min-width:0;line-height:1;border-radius:999px}
    .menu{display:none}
    .mobile-menu{position:absolute;left:0;right:0;top:100%;display:none;padding:14px;background:#0b0f1a;border-top:1px solid rgba(255,255,255,.08);box-shadow:0 16px 40px rgba(0,0,0,.45)}
    .mobile-links{display:flex;flex-direction:column;gap:10px}
    .mobile-links .ghost{background:rgba(255,255,255,.02);border-color:rgba(255,255,255,.18)}
    .mobile-links .btn{width:100%;justify-content:center}
    .hero{text-align:center;padding:28px 0 10px}
    .h1{font-size:clamp(2rem,5.5vw,3.2rem);margin:0;font-weight:800}
    .lead{color:var(--muted);max-width:860px;margin:10px auto 0}
    .steps{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:16px 0}
    .step-pill{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.04);font-weight:600}
    .n{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand-1),var(--brand-2));color:#061017;font-size:12px}
    .chooser{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin:24px auto}
    .card{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;display:flex;flex-direction:column;justify-content:space-between}
    .card h3{margin:0 0 6px;font-size:1.2rem}.card p{margin:0;color:var(--muted)}
    .badge{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04);color:#cfe3ff;display:inline-block;margin-bottom:8px}
    .actions{display:flex;gap:10px;margin-top:14px}
    .seg{display:flex;justify-content:center;gap:10px;margin:22px auto}
    .seg button{border:0;padding:10px 18px;border-radius:999px;font-weight:700;cursor:pointer;background:rgba(255,255,255,.06);color:var(--muted)}
    .seg button.active{background:linear-gradient(135deg,var(--brand-1),var(--brand-2));color:#061017}
    .plan-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;align-items:stretch}
    .plan{display:flex;flex-direction:column;justify-content:space-between}
    .price-lg{font-size:32px;font-weight:800;margin:8px 0}
    .per{color:var(--muted);font-size:14px;font-weight:600}
    .desc{color:var(--muted);flex:1;margin:8px 0 12px}
    .plan.rec{outline:2px solid rgba(0,212,255,.25);box-shadow:0 0 0 5px rgba(124,58,237,.08),var(--shadow)}
    footer{text-align:center;padding:28px 0 36px;color:#b7c3d2;border-top:1px solid var(--border)}
    @media(max-width:700px){.btn{width:100%}} .panel{display:none;margin-bottom:40px} .panel.show{display:block} .anchor-offset{position:relative;top:-80px;display:block;height:0}
    @media (max-width:768px){.nav-links{display:none}.menu{display:block;background:#0f172a;color:#e9eefc;border:1px solid rgba(255,255,255,.28);box-shadow:0 8px 24px rgba(0,0,0,.45);padding:10px 14px;border-radius:999px}.menu:hover{filter:brightness(1.08)}.menu:active{transform:translateY(1px)}}
    /* Cuenta */
    .account-grid{display:grid;grid-template-columns:1fr;gap:16px;margin:12px auto}
    .account-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    input[type="email"],input[type="text"]{background:#0c1326;border:1px solid rgba(255,255,255,.12);color:var(--txt);padding:10px 12px;border-radius:10px;outline:none;width:100%}
    form{display:grid;grid-template-columns:1fr 1fr auto;gap:10px}
    @media(max-width:680px){form{grid-template-columns:1fr;}}
    .note{font-size:.92rem;color:#cbd5e1}
    .mini{font-size:.9rem;color:#a7b4c8}
    .pill-ok{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;background:rgba(34,197,94,.1)}
  </style>
</head>
<body>
<header>
  <div class="container nav">
    <a class="brand" href="index.html" aria-label="Volver al inicio">
      <span class="logo">
        <svg viewBox="0 0 24 24" fill="none"><path d="M5 12a7 7 0 1114 0v6.5a2.5 2.5 0 01-5 0V9.75a2.25 2.25 0 10-4.5 0V18.5a2.5 2.5 0 01-5 0V12z" stroke="#061017" stroke-width="1.7"/></svg>
      </span>
      <span>taply</span>
    </a>
    <nav class="nav-links" aria-label="Navegación principal">
      <a class="ghost" href="index.html#beneficios">Beneficios</a>
      <a class="ghost" href="index.html#como-funciona">Cómo funciona</a>
      <a class="ghost" href="index.html#reviews">Opiniones</a>
      <a class="ghost" href="suscripcion.html#cuenta">Mi cuenta</a>
      <a class="btn" href="index.html">Volver al inicio</a>
    </nav>
    <button class="menu ghost" id="menuBtn" aria-expanded="false" aria-controls="mobileMenu">Menú</button>
    <div class="mobile-menu" id="mobileMenu" role="menu" aria-label="Menú móvil">
      <div class="mobile-links">
        <a class="ghost" href="index.html#beneficios" role="menuitem">Beneficios</a>
        <a class="ghost" href="index.html#como-funciona" role="menuitem">Cómo funciona</a>
        <a class="ghost" href="index.html#reviews" role="menuitem">Opiniones</a>
        <a class="ghost" href="suscripcion.html#cuenta" role="menuitem">Mi cuenta</a>
        <a class="btn" href="index.html" role="menuitem">Volver al inicio</a>
      </div>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h1 class="h1">Empieza en dos pasos</h1>
    <p class="lead">1) Compra los NFC · 2) Activa tu suscripción. <span class="mini">Para pagar debes tener cuenta iniciada.</span></p>
    <div class="steps">
      <span class="step-pill"><span class="n">1</span> Comprar NFC</span>
      <span class="step-pill"><span class="n">2</span> Elegir suscripción</span>
    </div>

    <!-- SECCIÓN MI CUENTA -->
    <div id="cuenta" class="account-grid">
      <article class="card">
        <span class="badge">Mi cuenta</span>
        <div id="authLoggedOut">
          <h3 style="margin:0 0 6px">Crea tu cuenta o inicia sesión</h3>
          <p class="mini">Usaremos tu email para vincular tus pagos y mostrarte tu plan.</p>
          <form id="loginForm" autocomplete="on">
            <input type="email" id="email" name="email" placeholder="tu@email.com" required>
            <input type="text" id="name" name="name" placeholder="Nombre del negocio (opcional)">
            <button class="btn" type="submit">Entrar</button>
          </form>
          <p class="mini">Al continuar aceptas nuestra política de privacidad.</p>
        </div>
        <div id="authLoggedIn" style="display:none">
          <div class="account-row">
            <div>
              <div class="pill-ok"><span>✓</span> Sesión iniciada</div>
              <p class="mini" style="margin:.4rem 0 0">Email: <strong id="userEmail">—</strong></p>
            </div>
            <div class="actions">
              <button class="ghost" id="logoutBtn">Cerrar sesión</button>
              <button class="btn" id="portalBtn">Gestionar suscripción</button>
            </div>
          </div>
          <div id="subStatus" class="note" style="margin-top:10px">Cargando estado de suscripción…</div>
        </div>
      </article>
    </div>

    <div class="chooser">
      <article class="card">
        <span class="badge">Paso 1</span>
        <h3>Comprar NFC</h3>
        <p>Dispositivos para tus mesas/mostrador. Pago único.</p>
        <div class="actions" style="justify-content:center;gap:16px;flex-wrap:wrap">
          <div style="display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px;border-radius:999px">
            <button id="minus" class="btn sm" aria-label="Restar">−</button>
            <span id="qty">1</span>
            <button id="plus" class="btn sm" aria-label="Sumar">＋</button>
          </div>
          <div class="price">Importe total: <span id="totalNfc">—</span></div>
          <a class="btn" id="buyNfcBtn">Comprar ahora</a>
        </div>
        <p style="font-size:14px;text-align:center;margin-top:10px">Precio unitario: <strong id="unitPrice">—</strong></p>
      </article>

      <article class="card">
        <span class="badge">Paso 2</span>
        <h3>Activar Suscripción</h3>
        <p>Elige plan mensual o anual para gestionar reseñas y panel privado.</p>
        <div class="actions"><a href="#planes" id="showSub" class="btn">Ver planes</a></div>
      </article>
    </div>
  </div>
</section>

<!-- Panel Suscripción -->
<section id="panel-sub" class="panel container">
  <span id="planes" class="anchor-offset" aria-hidden="true"></span>
  <div class="seg">
    <button id="btn-month" class="active">Mensual</button>
    <button id="btn-year">Anual · ahorra</button>
  </div>

  <div class="plan-grid">
    <article class="card plan">
      <span class="badge">Basic</span>
      <div class="price-lg"><span id="p-basic">25€</span> <span class="per">/mes</span></div>
      <p class="desc">Empieza a captar reseñas con tu NFC listo y acceso a tus datos exportables.</p>
      <div class="actions"><a class="btn plan" data-tier="basic">Elegir Basic</a></div>
    </article>

    <article class="card plan rec">
      <span class="badge">Medio · Recomendado</span>
      <div class="price-lg"><span id="p-medio">35€</span> <span class="per">/mes</span></div>
      <p class="desc">Todo lo de Basic más un panel privado con filtros para controlar mejor tu reputación.</p>
      <div class="actions"><a class="btn plan" data-tier="medio">Elegir Medio</a></div>
    </article>

    <article class="card plan">
      <span class="badge">Pro</span>
      <div class="price-lg"><span id="p-pro">45€</span> <span class="per">/mes</span></div>
      <p class="desc">Todo lo de Medio con integración en Telegram, cambios bajo demanda y opción de incentivo para clientes.</p>
      <div class="actions"><a class="btn plan" data-tier="pro">Elegir Pro</a></div>
    </article>
  </div>
</section>

<footer>
  <div class="container">
    <p>Primero los dispositivos NFC, después la suscripción. Tras cada compra recibirás WhatsApp con instrucciones.</p>
  </div>
</footer>

<script>
  const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
  const fmt=v=>new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(v);
  window.addEventListener('load',()=>document.body.classList.add('is-loaded'));

  /* Menú móvil */
  const menuBtn=document.getElementById('menuBtn'); const mobileMenu=document.getElementById('mobileMenu');
  menuBtn?.addEventListener('click',()=>{const open=mobileMenu.style.display==='block';mobileMenu.style.display=open?'none':'block';menuBtn.setAttribute('aria-expanded',String(!open))});
  mobileMenu?.addEventListener('click',(e)=>{const a=e.target.closest('a');if(a){mobileMenu.style.display='none';menuBtn.setAttribute('aria-expanded','false')}})
  window.addEventListener('resize',()=>{if(window.innerWidth>768){mobileMenu.style.display='none';menuBtn.setAttribute('aria-expanded','false')}});

  /* PRECIOS */
  const PRICE={nfcUnit:5,monthly:{basic:25,medio:35,pro:45},annualDiscount:.20};
  let qty=1,yearly=false;
  function paintNfc(){ $('#qty').textContent=qty; $('#totalNfc').textContent=fmt(qty*PRICE.nfcUnit)+' (pago único)'; $('#unitPrice').textContent=fmt(PRICE.nfcUnit)+' por dispositivo' }
  $('#minus').addEventListener('click',()=>{qty=Math.max(1,qty-1);paintNfc()});
  $('#plus').addEventListener('click',()=>{qty=Math.min(99,qty+1);paintNfc()}); paintNfc();

  function planAmount(tier){const m=PRICE.monthly[tier];return yearly?Math.round(m*12*(1-PRICE.annualDiscount)):m}
  function paintPrices(){
    $('#p-basic').textContent=yearly?fmt(planAmount('basic')):PRICE.monthly.basic+'€';
    $('#p-medio').textContent=yearly?fmt(planAmount('medio')):PRICE.monthly.medio+'€';
    $('#p-pro').textContent=yearly?fmt(planAmount('pro')):PRICE.monthly.pro+'€';
    $$('.per').forEach(el=>el.textContent=yearly?'/año':'/mes');
  }
  $('#btn-month').addEventListener('click',()=>{yearly=false;$('#btn-month').classList.add('active');$('#btn-year').classList.remove('active');paintPrices()});
  $('#btn-year').addEventListener('click',()=>{yearly=true;$('#btn-year').classList.add('active');$('#btn-month').classList.remove('active');paintPrices()});
  paintPrices();

  /* FETCH helper con control de “error de red” */
  async function apiFetch(url, options={}){
    const opts={credentials:'include',headers:{'Content-Type':'application/json',...(options.headers||{})}, ...options};
    try{
      const res=await fetch(url,opts);
      const isJson=(res.headers.get('content-type')||'').includes('application/json');
      const data=isJson? await res.json().catch(()=>({})): {};
      if(!res.ok) throw new Error(data.message || `${res.status} ${res.statusText}`);
      return data;
    }catch(err){
      alert('Ups: '+(err?.message||'Error de red'));
      throw err;
    }
  }

  /* AUTH básica (email) */
  const authLoggedOut=$('#authLoggedOut'); const authLoggedIn=$('#authLoggedIn'); const userEmailEl=$('#userEmail'); const subStatusEl=$('#subStatus');
  async function refreshSession(){
    try{
      const me=await apiFetch('/api/auth/me');
      authLoggedOut.style.display='none'; authLoggedIn.style.display='block';
      userEmailEl.textContent=me.email || me.user?.email || '(sin email)';
      // cargar estado suscripción
      try{
        const st=await apiFetch('/api/subscription/status',{method:'GET'});
        if(st && st.active){
          subStatusEl.innerHTML=`<strong>Plan:</strong> ${st.tier || '—'} · ${st.interval || ''} — <span class="pill-ok">Activo</span>`;
        }else{
          subStatusEl.textContent='Sin suscripción activa.';
        }
      }catch{ subStatusEl.textContent='Sin suscripción activa.' }
    }catch{
      authLoggedOut.style.display='block'; authLoggedIn.style.display='none';
    }
  }
  $('#loginForm').addEventListener('submit',async(e)=>{
    e.preventDefault();
    const email=$('#email').value.trim(); const name=$('#name').value.trim();
    if(!email) return alert('Introduce tu email');
    await apiFetch('/api/auth/login',{method:'POST',body:JSON.stringify({email,name})});
    await refreshSession();
    location.hash='#planes'; // te lleva a elegir plan
  });
  $('#logoutBtn').addEventListener('click',async()=>{
    await apiFetch('/api/auth/logout',{method:'POST'});
    await refreshSession();
  });
  $('#portalBtn').addEventListener('click',async()=>{
    const {url}=await apiFetch('/api/subscription/portal',{method:'POST'});
    if(url) location.href=url;
  });
  refreshSession();

  /* Requiere sesión antes de pagar */
  async function requireAuth(){ try{ await apiFetch('/api/auth/me',{method:'GET'}); return true }catch{ location.hash='#cuenta'; $('html,body')?.scrollTo?.(0,0); return false } }

  $('#buyNfcBtn').addEventListener('click',async()=>{
    if(!(await requireAuth())) return;
    const payload={quantity:qty};
    const data=await apiFetch('/api/buy-nfc',{method:'POST',body:JSON.stringify(payload)});
    if(data.url) location.href=data.url;
  });

  $$('.btn.plan').forEach(btn=>btn.addEventListener('click',async()=>{
    if(!(await requireAuth())) return;
    const tier=btn.dataset.tier, payload={tier,frequency:yearly?'annual':'monthly'};
    const data=await apiFetch('/api/create-checkout-session',{method:'POST',body:JSON.stringify(payload)});
    if(data.url) location.href=data.url;
  }));

  // Mostrar paneles por hash
  function openFromHash(){const h=location.hash; if(h==='#planes'){ $('#panel-sub').classList.add('show'); $('#panel-sub').scrollIntoView({behavior:'smooth',block:'start'})}}
  $('#showSub').addEventListener('click',(e)=>{e.preventDefault();history.pushState(null,'','#planes');openFromHash()});
  window.addEventListener('hashchange',openFromHash); openFromHash();
</script>
</body>
</html>
